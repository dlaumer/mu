import{es as w,sr as b,sM as q,lq as P,sl as V}from"./index.f0143bd6.js";import{s as D,i as x}from"./cimAnalyzer.10562836.js";import{GeometryStyle as G,CIMSymbolRasterizer as E}from"./CIMSymbolRasterizer.5be381eb.js";import"./fontUtils.cd6ab53b.js";import"./BidiEngine.f5b8c89f.js";import"./TileClipper.7b9dd3ce.js";import"./enums.89506096.js";import"./number.dcd3e86c.js";import"./_commonjsHelpers.4421ccc9.js";import"./imageutils.d81aa1a1.js";import"./rasterizingUtils.fc5342b1.js";const g=new E(null,!0),h=w(b.size),F=w(b.maxSize),L=w(b.lineWidth),k=1;function A(t){const e=t==null?void 0:t.size;return typeof e=="number"?{width:e,height:e}:{width:e!=null&&typeof e=="object"&&"width"in e?e.width:null,height:e!=null&&typeof e=="object"&&"height"in e?e.height:null}}async function Z(t,e={}){var I;const{node:M,opacity:v,symbolConfig:m}=e,j=typeof m=="object"&&"isSquareFill"in m&&m.isSquareFill,S=e.cimOptions||e,o=S.geometryType||q((I=t==null?void 0:t.data)==null?void 0:I.symbol),i=A(e),{feature:C,fieldMap:z}=S;if(i.width==null||i.height==null){const r=await D.resolveSymbolOverrides(t.data,C,null,z,o);if(!r)return null;(t=t.clone()).data={type:"CIMSymbolReference",symbol:r},t.data.primitiveOverrides=void 0;const p=[];x.fetchResources(r,g.resourceManager,p),p.length>0&&await Promise.all(p);const l=x.getEnvelope(r,null,g.resourceManager),f=l==null?void 0:l.width,d=l==null?void 0:l.height;i.width=o==="esriGeometryPolygon"?h:o==="esriGeometryPolyline"?L:f!=null&&isFinite(f)?Math.min(f,F):h,i.height=o==="esriGeometryPolygon"?h:d!=null&&isFinite(d)?Math.max(Math.min(d,F),k):h}const c=await g.rasterizeCIMSymbolAsync(t,C,i,j||o!=="esriGeometryPolygon"?G.Preview:G.Legend,z,o);if(!c)return null;const{width:O,height:R}=c,n=document.createElement("canvas");n.width=O,n.height=R,n.getContext("2d").putImageData(c,0,0);const u=P(i.width),y=P(i.height),s=new Image(u,y);s.src=n.toDataURL(),v!=null&&(s.style.opacity=`${v}`);let a=s;if(e.effectView!=null){const r={shape:{type:"image",x:0,y:0,width:u,height:y,src:s.src},fill:null,stroke:null,offset:[0,0]};a=V([[r]],[u,y],{effectView:e.effectView})}return M&&a&&M.appendChild(a),a}export{Z as previewCIMSymbol};
