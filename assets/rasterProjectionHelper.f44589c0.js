import{fG as Q,fH as Mt,w as F,fI as z,t as G,r as S,fJ as $,a8 as Rt,bx as E,bH as Pt,d as bt,fK as T,fL as k,fM as ot,fN as St,fO as Nt,f as Et,fP as it}from"./index.7ded6657.js";var D;function mt(t,e,o){return!Pt(t,e,o)}function L(t,e,o){const r=mt(t,e,o);if(r&&!Q())throw new bt("rasterprojectionhelper-project","projection engine is not loaded");return r}(function(t){t[t.None=0]="None",t[t.North=1]="North",t[t.South=2]="South",t[t.Both=3]="Both"})(D||(D={}));const st=(t,e,o,r=0)=>{if(o[0]===1)return[0,0];let s=1,n=-1,i=1,u=-1;for(let c=0;c<t.length;c+=2)isNaN(t[c])||(s=s>t[c]?t[c]:s,n=n>t[c]?n:t[c],i=i>t[c+1]?t[c+1]:i,u=u>t[c+1]?u:t[c+1]);const{cols:f,rows:l}=e,a=(n-s)/f/o[0],d=(u-i)/l/o[1],h=2*r;let m=0,x=!1,g=[0,0];for(let c=0;c<f-3;c++){for(let M=0;M<l-3;M++){const y=c*l*2+2*M,p=(t[y]+t[y+4]+t[y+4*l]+t[y+4*l+4])/4,w=(t[y+1]+t[y+5]+t[y+4*l+1]+t[y+4*l+5])/4,R=Math.abs((p-t[y+2*l+2])/a),P=Math.abs((w-t[y+2*l+3])/d);if(R+P>m&&(m=R+P,g=[R,P]),h&&m>h){x=!0;break}}if(x)break}return g},Gt={3395:20037508342789244e-9,3410:17334193943686873e-9,3857:20037508342788905e-9,3975:17367530445161372e-9,4087:20037508342789244e-9,4088:20015108787169147e-9,6933:17367530445161372e-9,32662:20037508342789244e-9,53001:2001508679602057e-8,53002:1000754339801029e-8,53003:2001508679602057e-8,53004:2001508679602057e-8,53016:14152803599503474e-9,53017:17333573624304302e-9,53034:2001508679602057e-8,53079:20015114352186374e-9,53080:20015114352186374e-9,54001:20037508342789244e-9,54002:10018754171394624e-9,54003:20037508342789244e-9,54004:20037508342789244e-9,54016:14168658027268292e-9,54017:1736753044516137e-8,54034:20037508342789244e-9,54079:20037508342789244e-9,54080:20037508342789244e-9,54100:20037508342789244e-9,54101:20037508342789244e-9},A=32,B=4,K=B,X=new Map,H=new Map,j=500;async function $t(){Q()||await Mt()}function It(t,e,o){return L(t.spatialReference,e)?o?it(e,t.spatialReference,t):it(t.spatialReference,e,t):null}function At(t,e,o,r=null){const s=t.spatialReference;if(s.equals(e))return t;L(s,e,r);const n=o.center,i=new F({xmin:n.x-t.x/2,xmax:n.x+t.x/2,ymin:n.y-t.y/2,ymax:n.y+t.y/2,spatialReference:s}),u=z(i,e,r),f=v(e);let l;if(G(u)||S(f)&&u.width>=f){const a=$(s)/$(e);l={x:t.x*a,y:t.y*a}}else l={x:u.width,y:u.height};return l}function N(t,e=.01){return $(t)?e/$(t):0}function rt(t,e,o=null,r=!0){const s=t.spatialReference;if(s.equals(e))return t;L(s,e,o);const n=z(t,e,o);return r&&n&&xt([t],[n],s,e),n}function xt(t,e,o,r){const s=Y(o,!0),n=Y(r,!0),i=N(o,j),u=N(r,j);if(i&&S(s)&&S(n))for(let f=0;f<t.length;f++){const l=e[f];if(!l)continue;const{x:a}=t[f],{x:d}=l;d>=n[1]-u&&Math.abs(a-s[0])<i?l.x-=n[1]-n[0]:d<=n[0]+u&&Math.abs(a-s[1])<i&&(l.x+=n[1]-n[0])}}function kt(t){const{inSR:e,outSR:o,datumTransformation:r,preferPE:s}=t;if(e.equals(o)){const{points:n}=V(t,null);return n}if(e.isWebMercator&&o.isWGS84||e.isWGS84&&o.isWebMercator)return vt(t);if(L(e,o,r)&&s){if(e.isGeographic)return at(t);const n=O(e);if(S(n))return at(t)}return Tt(t)}function Tt(t){const{points:e}=V(t,null),{inSR:o,outSR:r,datumTransformation:s}=t,n=e.map(u=>new E(u[0],u[1],o)),i=z(n,r,s);return s&&xt(n,i,o,r),i.map(u=>u?[u.x,u.y]:[NaN,NaN])}function at(t){const{inSR:e,outSR:o,datumTransformation:r}=t,s=O(e),{points:n,mask:i}=V(t,s);if(!e.isGeographic){const f=e.wkid?T.coordsys(e.wkid):T.fromString(e.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,e.wkt);ot.projToGeog(f,n.length,n)}if(S(r)&&r.steps.length){let f;if(o.isGeographic&&(f=n.map(([a])=>a>179.9955?1:a<-179.9955?-1:0)),r.steps.forEach(a=>{const d=a.wkid?T.geogtran(a.wkid):T.fromString(k.PE_TYPE_GEOGTRAN,a.wkt);St.geogToGeog(d,n.length,n,null,a.isInverse?k.PE_TRANSFORM_2_TO_1:k.PE_TRANSFORM_1_TO_2)}),f)for(let a=0;a<n.length;a++){const d=f[a],h=n[a][0],m=h>179.9955?1:h<-179.9955?-1:0;d&&m&&d!==m&&(n[a][0]=d>0?h+360:h-360)}}if(!o.isGeographic){const f=O(o,!0),l=S(f)&&f.isEnvelope?[f.bbox[1],f.bbox[3]]:[-90,90];Ct(n,l);const a=o.wkid?T.coordsys(o.wkid):T.fromString(o.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,o.wkt);ot.geogToProj(a,n.length,n)}let u=n;if(i&&n.length!==i.length){u=[];for(let f=0,l=0;f<i.length;f++)i[f]?u.push(n[l++]):u.push([NaN,NaN])}return u}function vt(t){const{cols:e,rows:o,xres:r,yres:s,usePixelCenter:n,inSR:i,outSR:u}=t;let{xmin:f,ymax:l}=t;n&&(f+=r/2,l-=s/2);const a=[],d=[],h=Math.max(e,o);for(let x=0;x<h;x++){const g=f+r*Math.min(e,x),c=l-s*Math.min(o,x),M=z(new E({x:g,y:c,spatialReference:i}),u);x<=e&&a.push(M.x),x<=o&&d.push(M.y)}const m=[];for(let x=0;x<e;x++)for(let g=0;g<o;g++)m.push([a[x],d[g]]);return m}function O(t,e=!1){let o=t.wkid||t.wkt;if(!o||t.isGeographic)return null;if(o=String(o),X.has(o)){const i=X.get(o);return e?i==null?void 0:i.gcs:i==null?void 0:i.pcs}const r=t.wkid?T.coordsys(t.wkid):T.fromString(t.isGeographic?k.PE_TYPE_GEOGCS:k.PE_TYPE_PROJCS,t.wkt),s=lt(r,N(t,1e-4)),n=lt(r,0,!0);return X.set(o,{pcs:s,gcs:n}),e?n:s}function lt(t,e=0,o=!1){const r=Nt.generate(t),s=o?t.horizonGcsGenerate():t.horizonPcsGenerate();if(!r||!(s!=null&&s.length))return null;let n=!1,i=s.find(c=>c.getInclusive()===1&&c.getKind()===1);if(!i){if(i=s.find(c=>c.getInclusive()===1&&c.getKind()===0),!i)return null;n=!0}const u=o?0:(r.getNorthPoleLocation()===2?1:0)|(r.getSouthPoleLocation()===2?2:0),f=r.isPannableRectangle(),l=i.getCoord();if(n)return{isEnvelope:n,isPannable:f,vertices:l,coef:null,bbox:[l[0][0]-e,l[0][1]-e,l[1][0]+e,l[1][1]+e],poleLocation:u};let a=0;const d=[];let[h,m]=l[0],[x,g]=l[0];for(let c=0,M=l.length;c<M;c++){a++,a===M&&(a=0);const[y,p]=l[c],[w,R]=l[a];if(R===p)d.push([y,w,p,R,2]);else{const P=(w-y)/(R-p||1e-4),C=y-P*p;p<R?d.push([P,C,p,R,0]):d.push([P,C,R,p,1])}h=h<y?h:y,m=m<p?m:p,x=x>y?x:y,g=g>p?g:p}return{isEnvelope:!1,isPannable:f,vertices:l,coef:d,bbox:[h,m,x,g],poleLocation:u}}function V(t,e){const o=[],{cols:r,rows:s,xres:n,yres:i,usePixelCenter:u}=t;let{xmin:f,ymax:l}=t;if(u&&(f+=n/2,l-=i/2),G(e)){for(let m=0;m<r;m++)for(let x=0;x<s;x++)o.push([f+n*m,l-i*x]);return{points:o}}const a=new Uint8Array(r*s);if(e.isEnvelope){const{bbox:[m,x,g,c]}=e;for(let M=0,y=0;M<r;M++){const p=f+n*M,w=e.isPannable||p>=m&&p<=g;for(let R=0;R<s;R++,y++){const P=l-i*R;w&&P>=x&&P<=c&&(o.push([p,P]),a[y]=1)}}return{points:o,mask:a}}const d=e.coef,h=[];for(let m=0;m<s;m++){const x=l-i*m,g=[],c=[];for(let y=0;y<d.length;y++){const[p,w,R,P,C]=d[y];if(x===R&&R===P)g.push(p),g.push(w),c.push(2),c.push(2);else if(x>=R&&x<=P){const I=p*x+w;g.push(I),c.push(C)}}let M=g;if(g.length>2){let y=c[0]===2?0:c[0],p=g[0];M=[];for(let w=1;w<c.length;w++)c[w]===2&&w!==c.length-1||(c[w]!==y&&(M.push(y===0?Math.min(p,g[w-1]):Math.max(p,g[w-1])),y=c[w],p=g[w]),w===c.length-1&&M.push(c[w]===0?Math.min(p,g[w]):Math.max(p,g[w])));M.sort((w,R)=>w-R)}else g[0]>g[1]&&(M=[g[1],g[0]]);h.push(M)}for(let m=0,x=0;m<r;m++){const g=f+n*m;for(let c=0;c<s;c++,x++){const M=l-i*c,y=h[c];if(y.length===2)g>=y[0]&&g<=y[1]&&(o.push([g,M]),a[x]=1);else if(y.length>2){let p=!1;for(let w=0;w<y.length;w+=2)if(g>=y[w]&&g<=y[w+1]){p=!0;break}p&&(o.push([g,M]),a[x]=1)}}}return{points:o,mask:a}}function Ct(t,e){const[o,r]=e;for(let s=0;s<t.length;s++){const n=t[s][1];(n<o||n>r)&&(t[s]=[NaN,NaN])}}function ht(t){const e=v(t[0].spatialReference);if(t.length<2||G(e))return t[0];let{xmin:o,xmax:r,ymin:s,ymax:n}=t[0];for(let i=1;i<t.length;i++){const u=t[i];r=u.xmax+e*i,s=Math.min(s,u.ymin),n=Math.max(n,u.ymax)}return new F({xmin:o,xmax:r,ymin:s,ymax:n,spatialReference:t[0].spatialReference})}function _t(t,e,o=null,r=!0){const s=t.spatialReference;if(s.equals(e))return t;const n=zt(t),i=v(s,!0),u=v(e);if(n===0||G(i)||G(u)){const l=ft(t,e,o,r);if(G(i)&&S(u)&&Math.abs(l.width-u)<N(e)&&Q()){const a=O(s);if(S(a)&&a.poleLocation===D.None&&t.width<(a.bbox[2]-a.bbox[0])/2)return Ot(t,e)||l}return l}const f=t.clone().normalize();if(f.length===1&&t.xmax<i&&t.xmax-i/2>N(s)){const{xmin:l,xmax:a}=t;for(let d=0;d<=n;d++){const h=d===0?l:-i/2,m=d===n?a-i*d:i/2;f[d]=new F({xmin:h,xmax:m,ymin:t.ymin,ymax:t.ymax,spatialReference:s})}}return ht(f.map(l=>ft(l,e,o,r)).filter(S))}function Ot(t,e){const o=v(e);if(G(o))return null;let{xmin:r,ymin:s,xmax:n,ymax:i}=t;const u=t.spatialReference,f=new Rt({spatialReference:u,rings:[[[r,s],[n,s],[n,i],[r,i],[r,s]]]}),l=z(f,e);if(l.rings.length!==2||!l.rings[0].length||!l.rings[1].length)return null;const{rings:a}=l,d=N(u),h=new F({spatialReference:e});for(let m=0;m<2;m++){r=n=a[m][0][0],s=i=a[m][0][1];for(let x=0;x<a[m].length;x++)r=r>a[m][x][0]?a[m][x][0]:r,n=n<a[m][x][0]?a[m][x][0]:n,s=s>a[m][x][1]?a[m][x][1]:s,i=i<a[m][x][1]?a[m][x][1]:i;if(m===0)h.ymin=s,h.ymax=i,h.xmin=r,h.xmax=n;else if(h.ymin=Math.min(h.ymin,s),h.ymax=Math.max(h.ymax,i),Math.abs(n-o/2)<d)h.xmin=r,h.xmax=h.xmax+o;else{if(!(Math.abs(r+o/2)<d))return null;h.xmax=n+o}}return h}function ft(t,e,o=null,r=!0,s=!0){const n=t.spatialReference;if(n.equals(e)||!e)return t;L(n,e,o);const i=z(t,e,o);if(s&&e.isWebMercator&&i&&(i.ymax=Math.min(20037508342787e-6,i.ymax),i.ymin=Math.max(-20037508342787e-6,i.ymin),i.ymin>=i.ymax))return null;if(!r||!i)return i;const u=Y(n,!0),f=Y(e,!0);if(G(u)||G(f))return i;const l=N(n,.001),a=N(n,j),d=N(e,.001);if(Math.abs(i.xmin-f[0])<d&&Math.abs(i.xmax-f[1])<d){const h=Math.abs(t.xmin-u[0]),m=Math.abs(u[1]-t.xmax);if(h<l&&m>a){i.xmin=f[0];const x=[];x.push(new E(t.xmax,t.ymin,n)),x.push(new E(t.xmax,(t.ymin+t.ymax)/2,n)),x.push(new E(t.xmax,t.ymax,n));const g=x.map(c=>rt(c,e,o)).filter(c=>!isNaN(c==null?void 0:c.x)).map(c=>c.x);i.xmax=Math.max.apply(null,g)}if(m<l&&h>a){i.xmax=f[1];const x=[];x.push(new E(t.xmin,t.ymin,n)),x.push(new E(t.xmin,(t.ymin+t.ymax)/2,n)),x.push(new E(t.xmin,t.ymax,n));const g=x.map(c=>rt(c,e,o)).filter(c=>!isNaN(c==null?void 0:c.x)).map(c=>c.x);i.xmin=Math.min.apply(null,g)}}else{const h=N(e,.001);Math.abs(i.xmin-f[0])<h&&(i.xmin=f[0]),Math.abs(i.xmax-f[1])<h&&(i.xmax=f[1])}return i}function v(t,e=!1){if(!t)return null;const o=e?20037508342787e-6:20037508342788905e-9;return t.isWebMercator?2*o:t.wkid&&t.isGeographic?360:2*Gt[t.wkid]||null}function Y(t,e=!1){if(t.isGeographic)return[-180,180];const o=v(t,e);return S(o)?[-o/2,o/2]:null}function ct(t,e,o,r){let s=(t-e)/o;return s-Math.floor(s)!=0?s=Math.floor(s):r&&(s-=1),s}function zt(t,e=!1){const o=v(t.spatialReference);if(G(o))return 0;const r=e?0:-(o/2),s=N(t.spatialReference),n=!e&&Math.abs(t.xmax-o/2)<s?o/2:t.xmax,i=!e&&Math.abs(t.xmin+o/2)<s?-o/2:t.xmin;return ct(n,r,o,!0)-ct(i,r,o,!1)}function Bt(t){const e=t.storageInfo.origin.x,o=v(t.spatialReference,!0);if(G(o))return{originX:e,halfWorldWidth:null,pyramidsInfo:null};const r=o/2,{nativePixelSize:s,storageInfo:n,extent:i}=t,{maximumPyramidLevel:u,blockWidth:f,pyramidScalingFactor:l}=n;let a=s.x;const d=[],h=S(t.transform)&&t.transform.type==="gcs-shift",m=e+(h?0:r),x=h?o-e:r-e;for(let g=0;g<=u;g++){const c=(i.xmax-e)/a/f,M=c-Math.floor(c)==0?c:Math.ceil(c),y=x/a/f,p=y-Math.floor(y)==0?y:Math.ceil(y),w=Math.floor(m/a/f),R=Math.round(m/a)%f,P=(f-Math.round(x/a)%f)%f;d.push({resolutionX:a,blockWidth:f,datsetColumnCount:M,worldColumnCountFromOrigin:p,leftMargin:R,rightPadding:P,originColumnOffset:w}),a*=l}return{originX:e,halfWorldWidth:r,pyramidsInfo:d,hasGCSSShiftTransform:h}}function Lt(t){if(!t||t.isGeographic)return t;const e=String(t.wkid||t.wkt);let o;return H.has(e)?o=H.get(e):(o=(t.wkid?T.coordsys(t.wkid):T.fromString(k.PE_TYPE_PROJCS,t.wkt)).getGeogcs().getCode(),H.set(e,o)),new Et({wkid:o})}function jt(t){const e=t.isAdaptive&&t.spacing==null;let o=t.spacing||[A,A],r=U(t),s={cols:r.size[0]+1,rows:r.size[1]+1};const n=r.outofBoundPointCount>0&&r.outofBoundPointCount<r.offsets.length/2;let i=r.outofBoundPointCount===r.offsets.length/2||e&&n?[0,0]:st(r.offsets,s,o,K);const u=(i[0]+i[1])/2,f=t.projectedExtent.spatialReference,l=t.srcBufferExtent.spatialReference;if(e&&(n||u>K)&&(mt(f,l,t.datumTransformation)&&(f.isGeographic||S(O(f))),o=[B,B],r=U({...t,spacing:o}),s={cols:r.size[0]+1,rows:r.size[1]+1},i=st(r.offsets,s,o,K)),r.error=i,o[0]>1&&(r.coefficients=ut(r.offsets,s,n)),t.includeGCSGrid&&!f.isGeographic&&!f.isWebMercator)if(l.isGeographic)r.gcsGrid={offsets:r.offsets,coefficients:r.coefficients,spacing:o};else{const a=O(f);if(S(a)&&!a.isEnvelope){const d=Lt(f),h=_t(t.projectedExtent,d),{offsets:m}=U({...t,srcBufferExtent:h,spacing:o}),x=ut(m,s,n);r.gcsGrid={offsets:m,coefficients:x,spacing:o}}}return r}function U(t){const{projectedExtent:e,srcBufferExtent:o,pixelSize:r,datumTransformation:s,rasterTransform:n}=t,i=e.spatialReference,u=o.spatialReference,f=L(i,u),{xmin:l,ymin:a,xmax:d,ymax:h}=e,m=v(u),x=S(m)&&(t.hasWrapAround||(n==null?void 0:n.type)==="gcs-shift"),g=t.spacing||[A,A],c=g[0]*r.x,M=g[1]*r.y,y=g[0]===1,p=Math.ceil((d-l)/c-.1/g[0])+(y?0:1),w=Math.ceil((h-a)/M-.1/g[1])+(y?0:1),R=kt({cols:p,rows:w,xmin:l,ymax:h,xres:c,yres:M,inSR:i,outSR:u,datumTransformation:s,preferPE:g[0]<=B,usePixelCenter:y}),P=[];let C,I=0;const Z=y?-1:NaN,{xmin:tt,xmax:q,ymax:pt,width:gt,height:yt}=o,dt=N(u,j),wt=S(m)&&tt>0&&q>m/2;let nt=!1;if(f){const _=O(i);nt=S(_)&&_.poleLocation>0}for(let _=0;_<p;_++){const J=[];for(let W=0;W<w;W++){let b=R[_*w+W];if(x&&b[0]>q&&b[0]>m/2-dt?b[0]-=m:x&&_===0&&b[0]<0&&wt&&!n&&(b[0]+=m),!b||isNaN(b[0])||isNaN(b[1]))P.push(Z),P.push(Z),J.push(null),I++;else{if(n){const et=n.inverseTransform(new E({x:b[0],y:b[1],spatialReference:u}));b=[et.x,et.y]}J.push(b),_>0&&x&&C[W]&&b[0]<C[W][0]&&(b[0]+=m,nt&&b[0]>q&&b[0]>m&&(b[0]-=m)),P.push((b[0]-tt)/gt),P.push((pt-b[1])/yt)}}C=J}return{offsets:P,error:null,coefficients:null,outofBoundPointCount:I,spacing:g,size:y?[p,w]:[p-1,w-1]}}function ut(t,e,o){const{cols:r,rows:s}=e,n=new Float32Array((r-1)*(s-1)*2*6),i=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),u=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let f=0;f<r-1;f++){for(let l=0;l<s-1;l++){let a=f*s*2+2*l;const d=t[a],h=t[a+1],m=t[a+2],x=t[a+3];a+=2*s;const g=t[a],c=t[a+1],M=t[a+2],y=t[a+3];let p=0,w=12*(l*(r-1)+f);for(let R=0;R<3;R++)n[w++]=i[p++]*d+i[p++]*m+i[p++]*M;p=0;for(let R=0;R<3;R++)n[w++]=i[p++]*h+i[p++]*x+i[p++]*y;p=0;for(let R=0;R<3;R++)n[w++]=u[p++]*d+u[p++]*g+u[p++]*M;p=0;for(let R=0;R<3;R++)n[w++]=u[p++]*h+u[p++]*c+u[p++]*y}if(o)for(let l=0;l<n.length;l++)isNaN(n[l])&&(n[l]=-1)}return n}function Yt(t){const e=t.clone().normalize();return e.length===1?e[0]:ht(e)}function Ft(t,e,o){const{storageInfo:r,pixelSize:s}=e;let n=0,i=!1;const{pyramidResolutions:u}=r;if(S(u)&&u.length){const h=(t.x+t.y)/2,m=u[u.length-1],x=(m.x+m.y)/2,g=(s.x+s.y)/2;if(h<=g)n=0;else if(h>=x)n=u.length,i=h/x>8;else{let M,y=g;for(let p=1;p<=u.length;p++){if(M=(u[p-1].x+u[p-1].y)/2,h<=M){h===M?n=p:o==="down"?(n=p-1,i=h/y>8):n=o==="up"||h-y>M-h||h/y>2?p:p-1;break}y=M}}const c=n===0?s:u[n-1];return i&&Math.min(c.x,c.y)*$(e.spatialReference)>19567&&(i=!1),{pyramidLevel:n,pyramidResolution:new E({x:c.x,y:c.y,spatialReference:e.spatialReference}),excessiveReading:i}}const f=Math.log(t.x/s.x)/Math.LN2,l=Math.log(t.y/s.y)/Math.LN2,a=e.storageInfo.maximumPyramidLevel||0;n=o==="down"?Math.floor(Math.min(f,l)):o==="up"?Math.ceil(Math.max(f,l)):Math.round((f+l)/2),n<0?n=0:n>a&&(i=n>a+3,n=a);const d=2**n;return{pyramidLevel:n,pyramidResolution:new E({x:d*e.nativePixelSize.x,y:d*e.nativePixelSize.y,spatialReference:e.spatialReference}),excessiveReading:i}}export{jt as $,At as C,_t as J,mt as M,zt as Q,$t as T,v as U,Bt as V,rt as j,Yt as n,Ft as o,It as v};
