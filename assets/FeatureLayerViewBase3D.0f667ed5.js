import{f as D,jO as J,e_ as H,j as Y,r as p,m8 as T,e as l,y as d,a as F,G as R,t as _,m9 as K,aR as W,eR as X,ma as ee,mb as U,a7 as I,O as te,mc as re,jH as se,gw as ie,am as M,au as P,bh as V,es as Q,dK as A,z as j,bL as ae,Y as Z,md as G,me as oe,mf as L,mg as ne,mh as le,mi as O,mj as E,d as v,mk as ue,aj as x,a6 as B,bg as ce,ml as de,iJ as pe}from"./index.1c994251.js";import{L as he,w as ye,U as me}from"./FeatureLikeLayerView3D.96913f8f.js";import{n as fe}from"./LayerView3D.5d1f2a4a.js";import{r as ge}from"./EventedSet.8542dabe.js";import{o as k}from"./floorFilterUtils.4de71259.js";import{s as $,d as Fe}from"./popupUtils.1e985717.js";import{u as we}from"./LayerView.5346cb05.js";import{i as be}from"./RefreshableLayerView.dd035789.js";class _e{constructor(r){this._controller=r,this._handle=new ve(e=>r.schedule(e))}destroy(){this._handle.destroy()}invoke(r,e){return r.buffer&&r.buffer.byteLength!==0?(r.options.sourceSpatialReference&&r.options.sourceSpatialReference instanceof D&&(r.options={...r.options,sourceSpatialReference:r.options.sourceSpatialReference.toJSON()}),this._handle.invoke(r,e).then(s=>{let i=0,a=0;const c=async n=>{if(s.spatialReference=D.fromJSON(s.spatialReference),s.fields){for(;i<s.fields.length;)if(s.fields[i]=H.fromJSON(s.fields[i]),i++,n.madeProgress())return this._controller.reschedule(o=>c(o))}const u=s.spatialReference;for(;a<s.features.length;){const o=s.features[a];if(++a,o.uid=Y.generateUID(),p(o.geometry)&&(o.geometry.spatialReference=u,xe(o.geometry),n.madeProgress()))return this._controller.reschedule(y=>c(y))}return s};return this._controller.schedule(n=>c(n))})):Promise.resolve(null)}}function xe(t){switch(t.type){case"polyline":t.paths.reduce((r,e)=>r+e.length,0)<T&&(t.paths=t.hasZ||t.hasM?t.paths.map(r=>r.map(e=>[e[0],e[1],e[2]])):t.paths.map(r=>r.map(e=>[e[0],e[1]])));break;case"polygon":t.rings.reduce((r,e)=>r+e.length,0)<T&&(t.rings=t.hasZ||t.hasM?t.rings.map(r=>r.map(e=>[e[0],e[1],e[2]])):t.rings.map(r=>r.map(e=>[e[0],e[1]])))}}class ve extends J{constructor(r){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},r)}}let g=class extends R{constructor(t){super(t)}get queryFeaturesDehydrated(){var i,a;const t=this.layer.capabilities,r=t&&t.query,e=r&&r.supportsFormatPBF,s=this.layer.parsedUrl;if(e){_(this._decoder)&&(this._decoder=new _e(this.controller));const c={sourceSpatialReference:(a=(i=this.layer.spatialReference)==null?void 0:i.toJSON())!=null?a:null,applyTransform:!0,maxStringAttributeLength:1024};return(n,u)=>K(s,n,"pbf",this._createRequestOptions(u)).then(o=>(W(u),p(this._decoder)?this._decoder.invoke({buffer:o.data,options:c},u.signal):Promise.reject(X())))}return(c,n)=>ee(s,c,this.layer.spatialReference,this._createRequestOptions(n)).then(u=>U(u.data))}queryFeatureCount(t,r){return this.layer.queryFeatureCount(t,r)}destroy(){this._decoder=I(this._decoder)}_createRequestOptions(t){return{...t,query:{...this.layer.customParameters,token:this.layer.apiKey,...t==null?void 0:t.query}}}};l([d({constructOnly:!0})],g.prototype,"layer",void 0),l([d({constructOnly:!0})],g.prototype,"controller",void 0),l([d({readOnly:!0})],g.prototype,"queryFeaturesDehydrated",null),g=l([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],g);let w=class extends R{constructor(t){super(t)}queryFeaturesDehydrated(t,r){return this.layer.queryFeatures(t,r)}queryFeatureCount(t,r){return this.layer.queryFeatureCount(t,r)}};l([d({constructOnly:!0})],w.prototype,"layer",void 0),l([d({readOnly:!0})],w.prototype,"queryFeaturesDehydrated",null),w=l([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceMeshQuery3D")],w);let q=class extends R{constructor(t){super(t)}queryFeaturesDehydrated(t,r){return this.layer.queryFeatures(t,r)}};l([d({constructOnly:!0})],q.prototype,"layer",void 0),q=l([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileServiceQuery3D")],q);let b=class extends R{constructor(t){super(t)}queryFeaturesDehydrated(t,r){return this.source.queryFeaturesJSON(t,r).then(U,e=>{if(e&&e.name==="query-features-json:unsupported")return this.layer.queryFeatures(t,r);throw e})}queryFeatureCount(t,r){return this.layer.queryFeatureCount(t,r)}};function qe(t,r){return t.type==="feature"&&t.source.type==="feature-layer"?p(t.infoFor3D)?new w({layer:t}):new g({layer:t,controller:r}):t.type==="feature"&&t.source.type==="memory"||t.type==="csv"||t.type==="geojson"||t.type==="oriented-imagery"||t.type==="wfs"?new b({layer:t,source:t.source}):t.type==="ogc-feature"?new q({layer:t}):null}l([d({constructOnly:!0})],b.prototype,"layer",void 0),l([d({constructOnly:!0})],b.prototype,"source",void 0),b=l([F("esri.views.3d.layers.support.featureTileQuery3D.FeatureTileClientQuery3D")],b);class Re{constructor(r){this._memoryCache=null,this._capabilities=null;const e=r.layerView.layer;this._layerView=r.layerView,this.objectIdField=e.objectIdField,this.globalIdField="globalIdField"in e?e.globalIdField:null,this._returnZ=r.returnZ,this._returnM=r.returnM;const s=this._layerView.view.resourceController;this.query=qe(e,s.normal),s&&this._memoryCacheEnabled&&(this._memoryCache=s.memoryController.newCache(e.uid))}get _memoryCacheEnabled(){switch(this._layerView.layer.source.type){case"feature-layer":case"ogc-feature":case"oriented-imagery":return!0;case"csv":case"geojson":case"memory":case"wfs":return!1}}destroy(){this._memoryCache=I(this._memoryCache),this.query.destroy()}createQuery(){const r=this._layerView.layer.createQuery();return r.outFields=this._layerView.availableFields,r.returnZ=this._returnZ,r.returnM=this._returnM,r.outSpatialReference=this.tilingScheme.spatialReference,r}get memoryCache(){return this._memoryCache}get viewingMode(){return this._layerView.view.state.viewingMode}get tilingScheme(){return this._layerView.view.featureTiles.tilingScheme}get scheduler(){const r=this._layerView.view.resourceController;return r?r.scheduler:null}get geometryType(){return this._layerView.layer.geometryType}get fullExtent(){return this._layerView.layer.fullExtent}get tileMaxRecordCount(){return this._layerView.layer.capabilities.query.tileMaxRecordCount}get maxRecordCount(){return this._layerView.layer.capabilities.query.maxRecordCount}get capabilities(){return p(this._capabilities)||(this._capabilities=he(this._layerView.layer)),this._capabilities}logFetchError(r,e){r.error("#fetchTile()",this._layerView.layer,e&&e.message?e.message:e)}}const z="esri.views.layers.FeatureLayerView",C=te.getLogger(z),Oe=t=>{let r=class extends t{constructor(...e){super(...e),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([M(()=>{var s;const e=this.layer;return[(s=e==null?void 0:e.elevationInfo)==null?void 0:s.featureExpressionInfo,e&&"displayField"in e?e.displayField:null,e&&"timeInfo"in e&&e.timeInfo,e&&"renderer"in e&&e.renderer,e&&"labelingInfo"in e&&e.labelingInfo,e&&"floorInfo"in e&&e.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),P),V(()=>{var e;return(e=this.view)==null?void 0:e.floors},"change",()=>this._handleRequiredFieldsChange()),V(()=>{const e=this.layer;return e&&"sublayers"in e?e.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:e,layer:{fieldsIndex:s},requiredFields:i}=this;return"outFields"in e&&e.outFields?Q(s,[...A(s,e.outFields),...i]):Q(s,i)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(e){this._override("featureEffect",e)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){C.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("missing implementation")}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=p(this.filter)?this.filter.createQuery(e):new j(e);if(this.layer.type==="feature"){const i=k(this);p(i)&&(s.where=s.where?`(${s.where}) AND (${i})`:i)}return p(this.timeExtent)&&(s.timeExtent=p(s.timeExtent)?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new j(e)}queryFeatures(e,s){throw new Error("missing implementation")}queryObjectIds(e,s){throw new Error("missing implementation")}queryFeatureCount(e,s){throw new Error("missing implementation")}queryExtent(e,s){throw new Error("missing implementation")}async fetchPopupFeatures(e,s){const i=this.validateFetchPopupFeatures(s);if(i)throw i;return this.fetchClientPopupFeatures(s)}_loadArcadeModules(e){return e.get("expressionInfos.length")||Array.isArray(e.content)&&e.content.some(s=>s.type==="expression")?ae():Promise.resolve()}_handleRequiredFieldsChange(){const e=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",e),e.then(()=>{this._updatingRequiredFieldsPromise===e&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const e=this.view.type==="3d",{layer:s,layer:{fieldsIndex:i,objectIdField:a}}=this,c="renderer"in s&&s.renderer,n="orderBy"in s&&s.orderBy,u="featureReduction"in s?s.featureReduction:null,o=new Set,y=await Z([c?c.collectRequiredFields(o,i):null,G(o,s),e?oe(o,s):null,p(this.filter)?L(o,s,this.filter):null,p(this.featureEffect)?L(o,s,this.featureEffect.filter):null,u?ne(o,s,u):null,n?le(o,s,n):null]);if("timeInfo"in s&&s.timeInfo&&this.timeExtent&&O(o,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),s.type==="feature"&&(s.floorInfo&&O(o,s.fieldsIndex,[s.floorInfo.floorField]),e&&p(s.infoFor3D)&&(s.globalIdField==null&&C.error("globalIdField missing on 3DObjectFeatureLayer"),O(o,s.fieldsIndex,[s.globalIdField]))),s.type==="subtype-group"){E(o,i,s.subtypeField);const f=s.sublayers.map(S=>{var N;return Promise.all([(N=S.renderer)==null?void 0:N.collectRequiredFields(o,i),G(o,S)])});await Z(f)}for(const f of y)f.error&&C.error(f.error);E(o,i,a),e&&"displayField"in s&&s.displayField&&E(o,i,s.displayField);const m=Array.from(o).sort();this._set("requiredFields",m)}validateFetchPopupFeatures(e){var s;if(_(e))return null;for(const i of(s=e.clientGraphics)!=null?s:[]){const a=i.layer;if("popupEnabled"in a&&!a.popupEnabled)return new v("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(i.isAggregate){const c="featureReduction"in a?a.featureReduction:null;if(!(c&&"popupTemplate"in c&&c.popupEnabled&&c.popupTemplate))return new v("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a})}else if("popupTemplate"in a&&!$(a,e))return new v("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})}}async fetchClientPopupFeatures(e){const s=p(e)?e.clientGraphics:null;if(!s||s.length===0)return[];const i=new Array(s.length),a=new Map,c=await this.createPopupQuery(e);for(let n=0;n<s.length;n++){const u=s[n];if(u.isAggregate){i[n]=u;continue}const o=u.layer;if(!("popupEnabled"in o))continue;const y=A(this.layer.fieldsIndex,c.outFields),m=$(o,e);if(_(m))continue;const f=await this._loadArcadeModules(m);f&&f.arcadeUtils.hasGeometryOperations(m)||!ue(y,u)?a.set(u.getObjectId(),{graphic:u,index:n}):i[n]=u}if(this.layer.type==="stream"||a.size===0)return i.filter(Boolean);c.objectIds=Array.from(a.keys());try{const n=await this.layer.queryFeatures(c);for(const u of n.features){const{graphic:{geometry:o},index:y}=a.get(u.getObjectId());u.geometry||(u.geometry=o),i[y]=u}}catch{}return i.filter(Boolean)}async createPopupQuery(e){const s=this.layer.createQuery(),i=new Set;let a=!1;const c=p(e)&&e.clientGraphics?e.clientGraphics.map(n=>n.layer):[this.layer];for(const n of c){if(!("popupEnabled"in n))continue;const u=$(n,e);if(_(u))continue;const o=await this._loadArcadeModules(u),y=o&&o.arcadeUtils.hasGeometryOperations(u);a=!(this.layer.geometryType!=="point"&&!y);const m=await Fe(this.layer,u);for(const f of m)i.add(f)}if(s.returnGeometry=a,s.returnZ=a,s.returnM=a,s.outFields=Array.from(i),s.outSpatialReference=this.view.spatialReference,this.layer.type==="feature"){const n=k(this);p(n)&&(s.where=s.where?`(${s.where}) AND (${n})`:n)}return s}canResume(){return!!super.canResume()&&(!p(this.timeExtent)||!this.timeExtent.isEmpty)}};return l([d()],r.prototype,"_updatingRequiredFieldsPromise",void 0),l([d({readOnly:!0})],r.prototype,"availableFields",null),l([d({type:re})],r.prototype,"featureEffect",null),l([d({type:se})],r.prototype,"filter",void 0),l([d(ie)],r.prototype,"timeExtent",void 0),l([d()],r.prototype,"layer",void 0),l([d({type:Number})],r.prototype,"maximumNumberOfFeatures",null),l([d({readOnly:!0,type:Boolean})],r.prototype,"maximumNumberOfFeaturesExceeded",null),l([d({readOnly:!0})],r.prototype,"requiredFields",void 0),l([d()],r.prototype,"suspended",void 0),l([d()],r.prototype,"view",void 0),r=l([F(z)],r),r};let h=class extends be(ye(Oe(fe(we)))){constructor(t){super(t),this._controllerTotal=0,this._processorTotal=0,this.suspendResumeExtentMode="data"}initialize(){this.handles.add(M(()=>this._updatingRequiredFieldsPromise,t=>this.updatingHandles.addPromise(t),P))}destroy(){this.updatingHandles.removeAll(),this.handles.removeAll(),this._fetcherContext=I(this._fetcherContext)}get maximumNumberOfFeatures(){var t,r;return(r=(t=this.controller)==null?void 0:t.maximumNumberOfFeatures)!=null?r:this._get("maximumNumberOfFeatures")}set maximumNumberOfFeatures(t){this._set("maximumNumberOfFeatures",t),this.controller&&(this.controller.maximumNumberOfFeatures=t)}get maximumNumberOfFeaturesExceeded(){return!!this.controller&&!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded)}get updatingProgressValue(){var e,s;let t=0;if((e=this.controller)!=null&&e.updating){const i=this.controller.updatingRemaining,a=Math.max(this.controller.updatingTotal,this._controllerTotal);a>0&&(t=(a-i)/a,this._controllerTotal=a)}let r=0;if((s=this.processor)!=null&&s.updating){const i=this.processor.updatingRemaining,a=Math.max(i,this._processorTotal);a>0&&(r=(a-i)/a,this._processorTotal=a)}return .5*(t+r)}get updatePolicy(){if(!this.controller)return x.ASYNC;switch(this.controller.mode){case"snapshot":{const t=Ee[this.layer.geometryType];return t==null||this.controller.serviceDataCount>t?x.ASYNC:x.SYNC}case"tiles":return x.ASYNC}}get hasZ(){const t=this.layer,r=t.capabilities&&t.capabilities.data;return!(!r||!r.supportsZ)&&("returnZ"in t&&t.returnZ!=null?t.returnZ:r.supportsZ)}get hasM(){const t=this.layer,r=t.capabilities&&t.capabilities.data;return!(!r||!r.supportsM)&&"returnM"in t&&t.returnM!=null&&t.returnM}setVisibility(t,r){var e;(e=this.processor)==null||e.setObjectIdVisibility(t,r)}createQuery(){return super.createQuery()}queryFeatures(t,r){const e=()=>super.queryFeatures(t,r);return this.layer.geometryType==="mesh"?this._queryFeaturesMesh(this._ensureQuery(t),e):e()}beforeSetController(t){t.maximumNumberOfFeatures=this.maximumNumberOfFeatures}createController(){this._fetcherContext=new Re({layerView:this,returnZ:this.hasZ,returnM:this.hasM});const t=new me({layerView:this,context:this._fetcherContext,graphics:new ge,extent:this.clippingExtent});return this.updatingHandles.add(()=>t.serviceDataExtent,r=>{this.processor&&(this.processor.dataExtent=r)},B),this.handles.add(M(()=>this.suspended,r=>{r?t.suspend():t.resume()},P)),this.updatingHandles.add(()=>{var r;return(r=this.processor)==null?void 0:r.displayFeatureLimit},r=>t.displayFeatureLimit=r,B),this.handles.add(ce(()=>!this.updating,()=>{this._controllerTotal=0,this._processorTotal=0})),t}async doRefresh(t){t&&!this.suspended&&this.controller&&this.controller.refetch(),this.processor.refreshFilter()}getUsedMemory(){var t,r,e,s;return((r=(t=this.processor)==null?void 0:t.usedMemory)!=null?r:0)+((s=(e=this.controller)==null?void 0:e.memoryForUnusedFeatures)!=null?s:0)}getUnloadedMemory(){var i,a,c,n,u,o,y,m;const t=(a=(i=this.processor)==null?void 0:i.unprocessedMemoryEstimate)!=null?a:0,r=(n=(c=this.controller)==null?void 0:c.expectedFeatureDiff)!=null?n:0,e=(o=(u=this.processor)==null?void 0:u.loadedFeatures)!=null?o:0,s=e/(e+r);return t+r*((m=(y=this.processor)==null?void 0:y.usedMemoryPerFeature)!=null?m:0)*s}ignoresMemoryFactor(){var t;return(t=this.controller)==null?void 0:t.hasMaximumNumberOfFeaturesOverride}async _queryFeaturesMesh(t,r){await this._validateQueryFeaturesMesh(t);const e=await r();if(t&&t.outStatistics||_(this.graphics3DProcessor))return e;const s=this.layer.objectIdField,i=this.graphics3DProcessor.graphics3DGraphicsByObjectID,a=[];for(const c of e.features)if(c.geometry){const n=i.get(c.attributes[s]);n&&(c.geometry=de(n.graphic.geometry),a.push(c))}else a.push(c);return e.features=a,e}async _validateQueryFeaturesMesh(t){if(!t)return;const r=s=>{throw new v("feature-layer-view:unsupported-query",`Queries on Mesh feature collection layers do not support '${s}'`)},e=["quantizationParameters","geometryPrecision","maxAllowableOffset"];for(const s of e)t[s]!=null&&r(s);"returnM"in t&&t.returnM&&r("returnM"),"returnCentroid"in t&&t.returnCentroid&&r("returnCentroid"),p(t.outSpatialReference)&&!t.outSpatialReference.equals(this.view.spatialReference)&&r("outSpatialReference")}get performanceInfo(){var s,i,a,c,n,u,o;const t=(s=this.controller)==null?void 0:s.displayFeatureLimit,r=p(t)?t.averageSymbolComplexity:void 0,e=p(r)?`f:${r.primitivesPerFeature},v:${r.primitivesPerCoordinate}`:"n/a";return{...this._getResourceInfo(),partial:this.maximumNumberOfFeaturesExceeded,mode:(a=(i=this.controller)==null?void 0:i.mode)!=null?a:"n/a",symbolComplexity:e,nodes:(n=(c=this.controller)==null?void 0:c.tileDescriptors.length)!=null?n:0,...(o=(u=this.controller)==null?void 0:u.debug)!=null?o:{storedFeatures:0,totalVertices:0}}}get test(){var t;return{updatePolicy:this.updatePolicy,controller:this.controller,loadedGraphics:(t=this.controller)==null?void 0:t.graphics}}};l([d()],h.prototype,"layer",void 0),l([d()],h.prototype,"controller",void 0),l([d()],h.prototype,"_controllerTotal",void 0),l([d()],h.prototype,"_processorTotal",void 0),l([d()],h.prototype,"maximumNumberOfFeatures",null),l([d()],h.prototype,"maximumNumberOfFeaturesExceeded",null),l([d(pe)],h.prototype,"updatingProgress",void 0),l([d({readOnly:!0})],h.prototype,"updatingProgressValue",null),l([d({readOnly:!0})],h.prototype,"updatePolicy",null),l([d({readOnly:!0})],h.prototype,"hasZ",null),l([d({readOnly:!0})],h.prototype,"hasM",null),l([d()],h.prototype,"suspendResumeExtentMode",void 0),h=l([F("esri.views.3d.layers.FeatureLayerViewBase3D")],h);const Ee={point:5e3,polygon:500,polyline:1e3},Te=h;export{Te as j};
