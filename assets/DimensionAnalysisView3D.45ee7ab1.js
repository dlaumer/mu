import{bH as Zs,e0 as Ys,ny as Xs,nz as Js,r as m,bB as Ks,oz as Qs,t as g,bu as kt,cj as jt,bt as me,b3 as y,kz as V,oA as er,oB as tr,oi as Gn,nX as Qe,b0 as I,i0 as Fn,oC as se,oc as $,eb as z,np as ir,aZ as et,oD as an,nw as on,ef as ln,mU as le,dS as Hi,kA as Si,oE as dn,oF as Ze,jE as Se,e as h,y as p,a as F,G as ge,a5 as ii,a7 as yt,am as M,au as k,hg as nr,O as Nn,aa as E,oG as sr,oH as pt,lq as de,oI as rr,i2 as B,oJ as tt,bw as Mt,bx as Ye,os as cn,ex as wi,or as Pi,mD as xi,i4 as st,oK as T,oL as ar,kf as kn,oM as jn,ox as or,gG as lr,oN as dr,oO as cr,oP as hr,na as Ut,nD as x,mJ as hi,nF as Xe,ks as vt,oQ as qn,oR as we,nW as pe,iR as Un,oS as hn,oT as ur,mE as pr,oU as fr,oV as mr,oW as gr,ek as Wt,lv as bi,oX as Fe,bv as Wn,nS as _r,nR as ce,oY as un,b as Q,o7 as ui,gv as yr,o6 as Tt,gE as re,o5 as Bn,cF as Zn,od as xe,ky as Mi,oZ as vr,hn as Sr,mj as je,ob as Yn,o_ as pi,ke as wr,fz as Pr,fB as xr,nG as Le,iH as pn,o$ as br,kp as Mr,p0 as Er,j9 as fn,at as rt,a6 as Bt,p1 as Ei,lj as ze,oo as St,on as Et,om as ft,p2 as $r,p3 as Cr,p4 as $i,o9 as Or,ah as Ii,bm as Tr,an as it,jA as Rr,aR as Dr,p5 as Ar,_ as Rt,nt as Xn,gC as Lr,aJ as zr,fI as mn,gL as Vr,cK as Hr,av as Zt,p6 as Ir,bj as Jn,b8 as Kn,iM as wt,bk as Gi,p7 as Ci,x as Qn,d_ as Gr,bg as Fi,p8 as Oi,aV as Fr,aW as Nr,p9 as kr,pa as jr,mv as qr,pb as es,nY as Ur,nZ as Wr,pc as Br,pd as Zr,pe as dt,nH as Yr,nN as Xr,bh as gn}from"./index.f0143bd6.js";import{n as ts,g as $e,b as Jr,c as Kr,a as Qr}from"./LineVisualElement.de7495a8.js";import{t as R,r as ea,u as ta}from"./LengthDimension.d9211558.js";import{a as ia,v as is,f as Ve,i as na,c as sa,u as G,g as ra,b as aa}from"./Segment.ee3be1e9.js";import{i as ns,e as mt,x as ss,a as $t,U as oa,N as la,D as da,w as Ni,C as ca,b as rs,V as ki,v as _n,c as ha,s as ua,m as pa,d as fa}from"./analysisViewUtils.c00d3a5f.js";import{B as ma,C as as,z as ji,o as ga}from"./Factory.1ef4d713.js";import{g as _a,h as ya,E as A,Z as yn}from"./elevationInfoUtils.7e7fe510.js";import{t as os,S as va}from"./RightAngleQuadVisualElement.5660a418.js";import{d as Sa,S as vn}from"./PointVisualElement.edb3ccda.js";import{c as wa}from"./ImageMaterial.3510e1f9.js";import{b as j,L as fi,m as Pa,V as xa,g as ba,w as Ma}from"./EditGeometryOperations.89e2c385.js";import{D as Sn}from"./QueryEngineResult.d691c7bb.js";import{i as Ea}from"./dehydratedFeatureComparison.13f4f597.js";import{r as $a}from"./RenderTexture.a7d6a19a.js";function Ca(t){const e=Ys(t),i=e===Xs?Js:e;return Zs(t,i)?i:t}var Je;function Oa(t,e){const{spatialReference:i}=t;return Ks(i,e.spatialReference)?(Dt[0]=t.x,Dt[1]=t.y,Dt[2]=t.hasZ?t.z:0,At[0]=e.x,At[1]=e.y,At[2]=e.hasZ?e.z:0,ls(Dt,At,i)):null}function ls(t,e,i){const n=Ta(t,e,i,Je.Direct);return m(n)?ia(n.direct,n.unit):null}function Ta(t,e,i,n){const s=Ca(i),r=Qs(s);if(g(r))return null;const a=e[2]-t[2];if(n===Je.Vertical)return{verticalSigned:a,unit:r};if(!kt(t,i,mi,s)||!kt(e,i,Lt,s))return null;if(n===Je.Direct)return{direct:jt(Lt,mi),unit:r};if(me(zt,t[0],t[1],e[2]),!kt(zt,i,zt,s))return null;const l=jt(zt,Lt);return n===Je.Horizontal?{horizontal:l,unit:r}:{direct:jt(Lt,mi),horizontal:l,vertical:Math.abs(a),unit:r}}(function(t){t[t.Direct=0]="Direct",t[t.Horizontal=1]="Horizontal",t[t.Vertical=2]="Vertical"})(Je||(Je={}));const Dt=y(),At=y(),mi=y(),Lt=y(),zt=y();function Ra(t,e,i){if(g(t))return null;const n=t.dimensionSegment.startRenderSpace,s=t.dimensionSegment.endRenderSpace,r=ls(n,s,t.spatialReference);if(g(r))return null;const a=e===R.Vertical?er(r.value,r.unit,i):tr(r.value,r.unit,i);return is(r,a)}function Yt(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:n,measureType:s,orientation:r}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:n,measureType:s,orientation:r}}function Xt({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:n,orientation:s},r,a=null){if(g(t)||g(e))return null;const l=cs(m(a)?a.directSegment:new Ve,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},r),o=m(a)?a.primaryOffsetAxis:y();ni(o,{measureType:n,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:r});const d=m(a)?a.dimensionSegment:new Ve;return qi({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&n===R.Vertical?(I(d.startRenderSpace,l.startRenderSpace),I(d.endRenderSpace,l.endRenderSpace)):hs(d,{offsetAxis:o,offset:i,relativeToSegment:l,renderCoordsHelper:r}),{directSegment:l,dimensionSegment:d,primaryOffsetAxis:o,spatialReference:r.spatialReference}}function wn(t,e,i,n){return e===Pt.Start?(I(t.startRenderSpace,i.startRenderSpace),I(t.endRenderSpace,n.startRenderSpace)):(I(t.startRenderSpace,i.endRenderSpace),I(t.endRenderSpace,n.endRenderSpace)),t}var Pt;function Da(t,e,i,n){se(t.startRenderSpace,e.startRenderSpace,i,n),se(t.endRenderSpace,e.endRenderSpace,i,n)}function ds(t,e,i,n){switch(e){case R.Direct:return cs(t,i,n);case R.Horizontal:case R.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:a,geometry:l}=i;let o;a.measureType===R.Direct?(o=Aa(l,n)===s.z>r.z,e===R.Horizontal&&(o=!o)):o=!La(l);const[d,c]=o?[s,r]:[r,s],u=Ze(c,za);return e===R.Horizontal?u.z=d.z:(u.x=d.x,u.y=d.y),n.toRenderCoords(d,t.startRenderSpace),n.toRenderCoords(u,t.endRenderSpace),t}}}function cs(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}function Aa(t,e){const i=t.directSegment.eval(.5,$.get()),n=e.worldUpAtPosition(i,$.get()),s=t.dimensionSegment.eval(.5,$.get()),r=z($.get(),s,i);return!Gn(r,Qe)&&V(r,n)>0}function La(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:n,endRenderSpace:s}=t.directSegment;return dn(n,e)<dn(s,i)}(function(t){t[t.Start=0]="Start",t[t.End=1]="End"})(Pt||(Pt={}));const za=Se(0,0,0,null);function Va(t,e,i,n){const{directSegment:s}=i,r=ni($.get(),{measureType:e,directSegment:s,renderCoordsHelper:n}),a=hs(Ha,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:n}).eval(.5,$.get()),l=z($.get(),t,a);return V(l,r)*n.unitInMeters}const Ha=new Ve;function ni(t,e){const{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:a},directSegment:l,renderCoordsHelper:o}=e,d=l.eval(.5,$.get()),c=o.worldUpAtPosition(d,$.get()),u=o.worldBasisAtPosition(d,ir.Y,$.get());switch(i){case R.Horizontal:I(t,c);break;case R.Vertical:V(r,c)<V(a,c)?z(t,a,r):z(t,r,a),le(t,t,c),le(t,t,c);break;case R.Direct:{const f=et(e.orientation,0);if(qi({elevationAlignedStartPoint:n,elevationAlignedEndPoint:s}))an(Vt,-on(f),c),ln(t,u,Vt);else{const _=z($.get(),a,r),S=le($.get(),_,c);le(S,S,_),an(Vt,on(f),_),ln(t,S,Vt)}break}}return Gn(t,Qe)?I(t,u):Fn(t,t)}const Vt=Hi();function qi({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return m(t)&&m(e)&&t.x===e.x&&t.y===e.y}function hs(t,e){const{offsetAxis:i,offset:n,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:a,renderCoordsHelper:l}=e,o=n/l.unitInMeters,[d,c]=Ia(s,r,i,o);return se(t.startRenderSpace,a.startRenderSpace,i,d),se(t.endRenderSpace,a.endRenderSpace,i,c),t}function Ia(t,e,i,n=0){const s=V(e,i),r=V(t,i),a=Math.abs(s-r)+n;return s>r?[a,n]:[n,a]}function si(t,e,i){const n=e.directSegment.eval(.5,$.get());return i.worldUpAtPosition(n,t)}function Ui(t,e){const{startRenderSpace:i,endRenderSpace:n}=e.directSegment;return z(t,n,i)}function Wi(t,e,i={invert:!1}){const{startRenderSpace:n,endRenderSpace:s}=e.dimensionSegment;return i.invert?z(t,n,s):z(t,s,n)}function Ti(t,e){const i=t.directSegment.eval(.5,$.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}function Ga(t,e){return Si(Wi(Fa,t))/e**2}const Fa=y();function us(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(g(e)||g(i))return!1;const n=Oa(e,i);return m(n)&&is(n,"meters").value>ps}const ps=1e5;function xt(t){return m(t.geometry)}let Ce=class extends ge{constructor(t){super(t),this._handles=new ii}initialize(){const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles(t.on("change",({added:e,removed:i})=>{for(const n of i)this._removeComputation(n);for(const n of e)this._addComputation(n)}))}destroy(){this._handles=yt(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return na(this.view)}_addComputation(t){this._handles.has(t)||this._handles.add(M(()=>Yt(t),e=>{const{measureType:i}=e;if(us(e)&&i!==R.Direct){const s=Math.round(nr(ps,"meters","kilometers"));return Nn.getLogger(this.declaredClass).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${s} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const n=Xt(e,this.view.renderCoordsHelper,t.geometry);t.geometry=n,t.result.length=Ra(n,i,this._defaultUnit)},k),t)}_removeComputation(t){this._handles.remove(t)}};h([p({constructOnly:!0})],Ce.prototype,"analysisViewData",void 0),h([p({constructOnly:!0})],Ce.prototype,"view",void 0),h([p()],Ce.prototype,"analysis",null),h([p()],Ce.prototype,"_defaultUnit",null),Ce=h([F("esri.views.3d.analysis.Dimension.support.DimensionController")],Ce);const fs={main:new E([255,127,0])};class Na{constructor(){this.color=fs.main,this.opacity=.5,this.radius=5}}class ka{constructor(){this.color=new E([127,127,127]),this.opacity=.5,this.radius=5}}class ja{constructor(){this.lineSizeFraction=.8}}class qa{constructor(){this.color=fs.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}}class Ua{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}class Wa{constructor(){this.lineSizeFraction=.25}}class Ba{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}}class Za{constructor(){this.color=new E([255,127,0,.5])}}class Ya{constructor(){this.pointManipulators=new Na,this.offsetManipulator=new qa,this.orientationManipulator=new Ua,this.markers=new ja,this.labels=new Ba,this.offsetLine=new Wa,this.constraint=new Za,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new ka,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}}const D=new Ya;class Xa{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(i=>this.hasOwnProperty(i)&&e===this[i])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const i of ea)e(this.manipulatorForMeasureType(i),i)}manipulatorForMeasureType(e){switch(e){case R.Direct:return this.direct;case R.Horizontal:return this.horizontal;case R.Vertical:return this.vertical}}}function Ja(t,e){const i=la(t,E.toUnitRGB(D.pointManipulators.color),D.pointManipulators.opacity,fe);return i.available=!1,i.grabCursor="crosshair",i.radius=D.pointManipulators.radius,i.metadata=e.metadata,i.collisionPriority=1,i}function Ka(t,e){const i=[B(-.5,0,0),B(.5,0,0)],{lengthFraction:n}=D.offsetManipulator,s=tt(e.unfocusedMaterial,i.map(a=>Mt(y(),a,n))),r=s.instantiate({material:e.focusedMaterial});return new ns({view:t,renderObjects:[new mt(s,pt.Unfocused|pt.Selected|fe),new mt(r,pt.Focused|fe)],collisionType:{type:"line",paths:[i]},radius:Bi(e.lineSizePt)/2,metadata:e.metadata,available:!1,...ss})}function ms(t,{lineSizePt:e,material:i}){const{calloutOffsetPx:n,calloutOpacity:s,calloutWidth:r,discScale:a,focusMultiplier:l}=D.orientationManipulator;return{calloutLength:.25*rr*D.markers.lineSizeFraction*de(e)+n,calloutOpacity:s,calloutWidth:r,customStateMask:fe,discScale:a,focusMultiplier:l,material:i,metadata:t}}function Pn(t,e){return oa(t,ms(e.metadata,e))}function xn(t,e){da(t,ms(t.metadata,e))}function Qa(t,e){const i=[B(-.5,0,0),B(.5,0,0)],{lengthFraction:n}=D.offsetManipulator,s=tt(e.thinOffsetManipulatorMaterial,i),r=tt(e.unfocusedMaterial,i.map(l=>Mt(y(),l,n))),a=r.instantiate({material:e.focusedMaterial});return new ns({view:t,renderObjects:[new mt(r,pt.Unfocused|fe),new mt(a,pt.Focused|fe),new mt(s,fe)],collisionType:{type:"line",paths:[i]},radius:Bi(e.lineSizePt)/2,available:!1,metadata:e.metadata,...ss})}function eo(t,{isStart:e,createSnappingPipelineStep:i,dimension:n,onUpdate:s,view:r}){const a=e?"startPoint":"endPoint";return[$t(t,(o,d,c,u)=>{const f=ji(o),{snappingStep:_,cancelSnapping:S}=i(u);c=c.next(f).next(Ni(n,[a,"measureType","orientation"])).next(S),d.next(f).next(ma(r)).next(..._).next(P=>{const w=Ze(P.mapEnd,new Ye);s(a==="startPoint"?{startPoint:w}:{endPoint:w})})})]}function to(t,{computation:e,view:i}){return[$t(t,(n,s,r)=>{if(!xt(e)||!n.selected)return;const{geometry:a,dimension:l}=e,o=ji(n);s.next(o).next(_s(i,l,a.dimensionSegment,a.primaryOffsetAxis)),r.next(o).next(Ni(l,["offset"]))})]}function io(t,{computation:e,view:i}){return[$t(t,(n,s,r)=>{gs({cancel:r,computation:e,settingHeading:!0,steps:s,view:i})})]}function no(t,{computation:e,view:i}){return[$t(t,(n,s,r)=>{gs({cancel:r,computation:e,settingHeading:!1,steps:s,view:i})}),t.events.on("immediate-click",n=>{so(n,e,i)})]}function so(t,e,i){const{dimension:n,geometry:s}=e;if(n.orientation===90||n.orientation===270)return n.orientation=0,void t.stopPropagation();if(g(s))return;const{renderCoordsHelper:r}=i,a=Xt({...Yt(e),orientation:90},r),l=Xt({...Yt(e),orientation:270},r);if(g(a)||g(l))return;const o=Ti(a,r),d=Ti(l,r),c=ys(s,i),u=wi.shortestSignedDiff(c,o),f=wi.shortestSignedDiff(c,d);n.orientation=Math.abs(u)<Math.abs(f)?90:270,t.stopPropagation()}function gs(t){const{cancel:e,computation:i,settingHeading:n,steps:s,view:r}=t;if(!xt(i))return;const{renderCoordsHelper:a}=r,{dimension:l,geometry:o}=i,d=y(),c=Ss(y(),o,o.directSegment,a),u=ws($.get(),{forHeading:n,geometry:o,renderCoordsHelper:a}),f=Pi(c,u,xi()),_=et(l.orientation,n?()=>Ti(o,r.renderCoordsHelper):0);s.next(as(r,f)).next(S=>{S.action==="start"&&I(d,S.renderStart);const P=or(f),w=ca(d,S.renderEnd,c,P);let L=_-lr(w);n||(L=ro(L)),l.orientation=L}),e.next(Ni(l,["orientation"]))}function ro(t){const e=wi.normalize(t)%90;return e<D.orientationSnapThresholdDegrees?t-e:90-e<D.orientationSnapThresholdDegrees?t+(90-e):t}function ao(t,{computation:e,manipulatorMeasureType:i,view:n}){let s=R.Direct,r=0,a=0;return[t.events.on("grab-changed",l=>{if(l.action!=="start"||!xt(e))return;const{dimension:o,geometry:d}=e;s=o.measureType,r=o.offset,a=o.orientation;const c=I($.get(),t.renderLocation);o.measureType=i,o.offset=Va(c,i,d,n.renderCoordsHelper),o.orientation=0}),$t(t,(l,o,d)=>{if(!xt(e))return;const{geometry:c,dimension:u}=e,{renderCoordsHelper:f}=n,_=ds(Ps,i,e,f),S=ni($.get(),{measureType:i,directSegment:c.directSegment,renderCoordsHelper:f}),P=ji(l);o.next(P).next(_s(n,u,_,S)),d.next(P).next(w=>(u.measureType=s,u.offset=r,u.orientation=a,w))})]}function _s(t,e,i,n){const s=st($.get(),i.endRenderSpace,i.startRenderSpace);le(s,s,n);const r=Pi(i.startRenderSpace,s,xi()),a=Pi(i.startRenderSpace,n,xi()),l=e.offset;let o,d=0;const c=new rs;return c.next(as(t,r)).next(u=>{u.action==="start"&&(d=cn(a,u.renderStart));const f=(cn(a,u.renderEnd)-d)*t.renderCoordsHelper.unitInMeters;e.offset=l+f,o=u}),u=>(c.execute(u),o)}function ys(t,e){const{directSegment:i}=t,{renderCoordsHelper:n}=e,s=si($.get(),t,n),r=Ui($.get(),t),a=le($.get(),r,s),{viewForward:l}=e.state.camera;V(a,l)>0&&Mt(a,a,-1);const o=i.eval(.5,$.get());return n.headingAtPosition(o,a)}function oo(t,e,i){const{dimensionSegment:n,primaryOffsetAxis:s}=e,r=Wi(gt,e),a=T(r,Qe)?ar(Jt):ki(r,s,Qe,Jt),l=Math.max(kn(r),D.offsetManipulator.minLengthMeters/i.unitInMeters);jn(a,a,me(gt,l,l,l)),t.modelTransform=a,t.renderLocation=n.eval(.5,gt)}function lo(t,e,i){vs(t,e,i,{forHeading:!0})}function co(t,e,i){vs(t,e,i,{forHeading:!1})}function vs(t,e,i,{forHeading:n}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:a}=r,l=Mt(ho,a,s.offset>=0?1:-1),o=ws(uo,{forHeading:n,geometry:r,renderCoordsHelper:i});le(o,o,l);const d=ki(l,o,Qe,Jt);t.modelTransform=d,t.renderLocation=Ss(gt,r,r.dimensionSegment,i)}const ho=y(),uo=y();function po(t,e,i,n){const{geometry:s}=e,r=ds(Ps,i,e,n),a=ni(gt,{measureType:i,directSegment:s.directSegment,renderCoordsHelper:n}),l=z(gi,r.endRenderSpace,r.startRenderSpace),o=ki(l,a,Qe,Jt),d=kn(l);jn(o,o,me(gi,d,d,d)),t.modelTransform=o,t.renderLocation=r.eval(.5,gi)}function Ss(t,e,i,n){const{startRenderSpace:s,endRenderSpace:r}=i,a=fo(e,n)?s:r;return I(t,a)}function ws(t,{forHeading:e,geometry:i,renderCoordsHelper:n}){return e?si(t,i,n):Wi(t,i,{invert:!0})}function fo(t,e){const i=Ui(mo,t),n=si(go,t,e);return V(i,n)>0}const mo=y(),go=y();function _o(t){return de(t)+D.offsetManipulator.linePaddingPx}function Bi(t){return de(t)+D.offsetManipulator.focusedLinePaddingPx}const fe=sr.Custom1,gt=y(),gi=y(),Jt=Hi(),Ps=new Ve;function yo(t){let e,i,n=[],s=!1;function r(...a){return s&&e===this&&vo(a,n)||(i=t.apply(this,a),e=this,n=a,s=!0),i}return r}function vo(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0}var K;function So(t,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,geometry:t.geometry}}function wo(t,e){if(us(t))return K.Direct;if(!t.enabled)return null;const{geometry:i}=t;if(g(i)||T(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:n}=D,{camera:s}=e.state,r=si($.get(),i,e.renderCoordsHelper),a=Ui($.get(),i),l=Mt($.get(),r,V(a,r)),o=st($.get(),a,l),d=Si(o),c=Si(l),{startRenderSpace:u,endRenderSpace:f}=i.directSegment,_=Math.max(s.computeRenderPixelSizeAt(u)*n,s.computeRenderPixelSizeAt(f)*n)**2;return d<_?K.Vertical:c<_?K.Horizontal:null}function Po(t,e,{constraint:i,view:n}){const{unconstrainedGeometry:s}=t;if(g(s))return;const{renderCoordsHelper:r,spatialReference:a}=n,{startRenderSpace:l,endRenderSpace:o}=s.directSegment,d=r.fromRenderCoords(l,new Ye,a),c=r.fromRenderCoords(o,new Ye,a);let u;u=e==="start"?{startPoint:d}:{endPoint:c},xs(t,u,{constraint:i,elevationAlignedStartPoint:t.elevationAlignedStartPoint,elevationAlignedEndPoint:t.elevationAlignedEndPoint,unconstrainedGeometry:s,view:n})}function xs(t,e,i){const{constraint:n,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:a,view:l}=i,{dimension:o,previousConstraint:d,preConstraintProperties:c}=t;if(g(s)||g(r))return;const u=()=>{"startPoint"in e?o.startPoint=e.startPoint:"endPoint"in e&&(o.endPoint=e.endPoint)};if(g(n))u(),m(d)&&m(c)&&(o.measureType=c.measureType,o.orientation=c.orientation);else switch(o.measureType=R.Direct,n){case K.Horizontal:if(n!==d&&(o.orientation=0),"startPoint"in e){const f=e.startPoint;m(f)&&(f.z=r.z),o.startPoint=f}else if("endPoint"in e){const f=e.endPoint;m(f)&&(f.z=s.z),o.endPoint=f}break;case K.Vertical:if(n!==d&&(o.orientation=ys(a,l)),"startPoint"in e){const f=e.startPoint;m(f)&&(f.x=r.x,f.y=r.y),o.startPoint=f}else if("endPoint"in e){const f=e.endPoint;m(f)&&(f.x=s.x,f.y=s.y),o.endPoint=f}break;case K.Direct:n!==d&&m(c)&&(o.orientation=c.orientation),u()}t.previousConstraint=n,t.unconstrainedGeometry=a}(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"})(K||(K={}));class xo extends os{constructor(e){super(e),this._ray=hr(),this._isWorldDown=!1,this._start=y(),this._end=B(1,0,0),this._width=1,this._color=Ut(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Ut(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=J.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=x.OccludeAndTransparent,this._fadedExtensions=En,this._laserline=new Sa({view:this.view}),this.applyProps(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:i=>this._createObject3DResources(i),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:(i,n)=>this._recreateObject3DGeometry(i,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:i=>this._destroyExternalResources(i),recreateGeometry:i=>this._recreateDrapedGeometry(i)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,I(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),st(this._end,e,this._end),hi(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,T(this._start,e)||(I(this._start,e),hi(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,T(this._end,e)||(I(this._end,e),hi(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Xe(e,this._color)||(vt(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Xe(e,this._innerColor)||(vt(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=m(e)!==m(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(g(e)||g(this._stippleOffColor)||!Xe(e,this._stippleOffColor))&&(this._stippleOffColor=m(e)?qn(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&m(this._laserlineStyle)&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,m(e)&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===x.OccludeAndTransparentStencil?x.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=et(e,En),this.recreateGeometry()}_updateMaterial(){var i,n;const{materialParameters:e}=this;(i=we(this.object3dResources.resources))==null||i.material.setParameters(e),(n=we(this.drapedResources.resources))==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const i=new pe(this.materialParameters),n=new Array;return this._createObject3DGeometry(i,e,n),{material:i,geometries:n,forEach:s=>{s(i),n.forEach(s)}}}_destroyExternalResources(e){e.geometries=[],e.material.dispose()}_recreateObject3DGeometry(e,i){e.geometries.length=0,this._createObject3DGeometry(e.material,i,e.geometries)}_createObject3DGeometry(e,i,n){const s=this._createGeometry(e);n.push(s),i.addGeometry(s),this._updateVerticesObject3D(i)}_createDrapedResources(){const e=new pe(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const i=this._createGeometry(e);this._updateVerticesDraped(i);const n=new Un(i,{boundingInfo:i.boundingInfo});return n.computeBoundingSphere(n.transformation,n.boundingSphere),n}_createGeometry(e){const i=this.extensionType===J.FADED,n=i?[y(),y(),y(),y()]:[y(),y()];return tt(e,n,null,i?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=we(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const i=this._lineSegment;this._updateVertexAttributesObject3D(e,i),this._laserline.intersectsLine=i}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===J.FADED?this._updateLineSegmentFinite(bn):this._updateLineSegmentInfinite(this._extensionType,bn)}_updateLineSegmentFinite(e){return hn(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const n=this.view.state.camera;switch(ur(this._ray,ye),e){case J.LINE:ye.c0=-Number.MAX_VALUE;break;case J.RAY:case J.GROUND_RAY:{const a=this._ray.origin,l=et(this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&pr(ye.ray.direction,ye.ray.direction),this._extensionType===J.GROUND_RAY&&l!=null&&(ye.c1=Math.abs(o-l));break}}if(!fr(n.frustum,ye))return this._updateLineSegmentFinite(i);const s=mr(ye,be),r=gr(ye,bo);return hn(s,r,i)}_updateVertexAttributesObject3D(e,i){var r;const n=(r=e.geometries[0].getMutableAttribute(Wt.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(i))n[s++]=a[0],n[s++]=a[1],n[s++]=a[2];e.geometryVertexAttrsUpdated(e.geometries[0])}_updateVertexAttributesDraped(e,i){var r;const n=(r=e.getMutableAttribute(Wt.POSITION))==null?void 0:r.data;if(!n)return;let s=0;for(const a of this._lineVertices(i))n[s++]=a[0],n[s++]=a[1],n[s++]=bi;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===J.FADED?(yield Fe(e,-this.fadedExtensions.start,be),yield Fe(e,0,be),yield Fe(e,1,be),yield Fe(e,1+this.fadedExtensions.end,be)):(yield Fe(e,0,be),yield Fe(e,1,be))}}const ye=dr(),be=y(),bo=y(),bn=cr();var J;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(J||(J={}));const Mn=1/3,En={start:Mn,end:Mn};class Mo extends os{constructor(e){super(e),this._location=y(),this._direction=B(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ut(1,0,1,1),this._renderOccluded=x.OccludeAndTransparent,this.applyProps(e)}createObject3DResourceFactory(e){return{view:e,createResources:i=>this._createObject3DResources(i),destroyResources:i=>this._destroyObject3DResources(i),recreateGeometry:(i,n)=>this._recreateObject3DGeometry(i,n),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:i=>this._destroyDrapedResources(i),recreateGeometry:i=>this._recreateDrapedGeometry(i)}}get location(){return this._location}set location(e){T(this._location,e)||(I(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){T(this._direction,e)||(I(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){Fn(this._direction,st(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Xe(e,this._color)||(vt(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const i=new pe(this.materialParameters),n=new Array;return this._createObject3DGeometry(i,e,n),{material:i,geometries:n,forEach:s=>{s(i),n.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0,e.material.dispose()}_recreateObject3DGeometry(e,i){e.geometries.length=0,this._createObject3DGeometry(e.material,i,e.geometries)}_createObject3DGeometry(e,i,n){const[s,r]=this._createGeometries(e);i.addGeometry(s),i.addGeometry(r),n.push(s),n.push(r),this._updateVerticesObject3D(i)}_createDrapedResources(){const e=new pe(this.materialParameters),i=M(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:i}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[],e.material.dispose()}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const i=this._createGeometries(e);this._updateVerticesDraped(i);const n=i.map(s=>new Un(s,{boundingInfo:s.boundingInfo}));for(const s of n)s.computeBoundingSphere(s.transformation,s.boundingSphere);return n}_createGeometries(e){return[tt(e,[y(),y()]),tt(e,[y(),y()])]}_updateMaterial(){var i,n;const{materialParameters:e}=this;(i=we(this.object3dResources.resources))==null||i.material.setParameters(e),(n=we(this.drapedResources.resources))==null||n.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=we(this.object3dResources.object);e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const i=this.view.state.camera;i.projectToScreen(this.location,It),Wn(oe,this.location,this.direction),i.projectToScreen(oe,Ne),_r(Ne,ce(Ne,Ne,It)),this._updateVertexAttributesObject3D(i,e,0,It,Ne,1),this._updateVertexAttributesObject3D(i,e,1,It,Ne,-1)}_updateVertexAttributesObject3D(e,i,n,s,r,a){var u;const l=i.geometries[n],o=(u=l.getMutableAttribute(Wt.POSITION))==null?void 0:u.data;if(!o)return;const{start:d,end:c}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(un(d),oe),o[0]=oe[0],o[1]=oe[1],o[2]=oe[2],e.unprojectFromScreen(un(c),oe),o[3]=oe[0],o[4]=oe[1],o[5]=oe[2],i.geometryVertexAttrsUpdated(l)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:i},state:{contentPixelRatio:n}}}=this,{location:s,width:r,length:a,offset:l}=this,o=Eo;o.spatialReference=Q(i.renderer.spatialReference),o.x=s[0],o.y=s[1];const d=i.overlayPixelSizeInMapUnits(o)*n,c=r*d,u=a*d,f=l*d;this._updateVertexAttributesDraped(e[0],c,u,f,-1),this._updateVertexAttributesDraped(e[1],c,u,f,1)}_updateVertexAttributesDraped(e,i,n,s,r){var u;const a=(u=e.getMutableAttribute(Wt.POSITION))==null?void 0:u.data;if(!a)return;const{location:l,direction:o}=this,{start:d,end:c}=this._computeStartEnd(o,l,r,s,i,n);a[0]=d[0],a[1]=d[1],a[2]=bi,a[3]=c[0],a[4]=c[1],a[5]=bi,e.invalidateBoundingInfo()}_computeStartEnd(e,i,n,s,r,a){const l=ui($n,yr($n,e[1]*n,e[0]*-n),s+r/2),o=Tt(Ht,Tt(Ht,Tt(Ht,i,ui(Ht,e,a/2)),l),l);return{start:o,end:Tt(Cn,o,ui(Cn,e,-a))}}}const oe=y(),$n=re(),Ht=re(),Cn=re(),It=Bn(),Ne=Bn(),Eo=Se(0,0,void 0,null);let ie=class extends Zn{constructor(){super(...arguments),this.enabled=!0}};h([p({type:Boolean})],ie.prototype,"enabled",void 0),ie=h([F("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],ie);let C=class extends Zn{constructor(t){super(t),this.lineSnapper=new ie,this.parallelLineSnapper=new ie,this.rightAngleSnapper=new ie,this.rightAngleTriangleSnapper=new ie,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new E([255,127,0]),this.orangeTransparent=new E([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"lineSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"parallelLineSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"rightAngleSnapper",void 0),h([p({type:ie,constructOnly:!0,nonNullable:!0,json:{write:!0}})],C.prototype,"rightAngleTriangleSnapper",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],C.prototype,"shortLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],C.prototype,"distance",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"pointThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"intersectionParallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"parallelLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],C.prototype,"verticalLineThreshold",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"touchSensitivityMultiplier",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],C.prototype,"pointOnLineThreshold",void 0),h([p({type:E,nonNullable:!0})],C.prototype,"orange",void 0),h([p({type:E,nonNullable:!0})],C.prototype,"orangeTransparent",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"lineHintWidthReference",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"lineHintWidthTarget",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],C.prototype,"lineHintFadedExtensions",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],C.prototype,"parallelLineHintWidth",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],C.prototype,"parallelLineHintLength",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],C.prototype,"parallelLineHintOffset",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],C.prototype,"rightAngleHintSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],C.prototype,"rightAngleHintOutlineSize",void 0),h([p({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],C.prototype,"satisfiesConstraintScreenThreshold",void 0),C=h([F("esri.views.interactive.snapping.Settings.Defaults")],C);const b=new C;var H;(function(t){t[t.FEATURE=1]="FEATURE",t[t.SELF=2]="SELF",t[t.ALL=3]="ALL"})(H||(H={}));function sd(t){return t}function bs(t){return xe(t)}function $o(t,e,i){return B(t,e,i)}function O(t,e,i){return g(t)?null:ht(i.coordinateHelper.vectorToDehydratedPoint(t,Co),e,i)}function ht(t,e,i){var r,a;if(g(t))return null;if(g(e))return B(t.x,t.y,(r=t.z)!=null?r:0);if(e.type==="2d")return B(t.x,t.y,0);const{elevationInfo:n}=i,s=(a=_a(e,t,n,A))!=null?a:0;return B(t.x,t.y,s)}function On(t,e,{z:i,m:n,spatialReference:s,elevationInfo:r}){var o;if(i==null&&n==null){const d=Se(t[0],t[1],void 0,s);return n!=null&&(d.m=n,d.hasM=!0),d}if(g(e)||e.type==="2d"){const d=Se(t[0],t[1],i,s);return n!=null&&(d.m=n,d.hasM=!0),d}const a=(o=ya(e,t,s,A,r))!=null?o:0,l=Se(t[0],t[1],a,s);return n!=null&&(l.m=n,l.hasM=!0),l}function Tn(t,e){return Se(t[0],t[1],t[2],e)}const Co=Se(0,0,0,null),Rn={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},Dn={toggle:"Control"};function He(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}function Oo(t,e){return Math.sqrt(He(t,e))}function Zi(t,e){e.sort((i,n)=>Mi(i.targetPoint,t)-Mi(n.targetPoint,t))}var q;function rd({point:t,distance:e,types:i,coordinateHelper:{spatialReference:n}},s,r){return{point:Se(t[0],t[1],t[2],n.toJSON()),mode:s,distance:e,types:i,query:m(r)?r.toJSON():{where:"1=1"}}}function Kt(t,e,i){return{left:O(t.leftVertex.pos,e,i),right:O(t.rightVertex.pos,e,i)}}function ad(t){return t.createQuery()}function To(t,e=()=>{}){const i=M(()=>({view:t.view,snappingOptions:t.snappingOptions}),({view:n,snappingOptions:s})=>{const r="snapping-toggle",a=vr.TOOL;if(t.removeHandles(r),n&&m(s)){const l=[n.on("key-down",o=>{o.key!==Dn.toggle||o.repeat||(s.enabledToggled=!0,e())},a),n.on("key-up",o=>{o.key===Dn.toggle&&(s.enabledToggled=!1,e())},a),n.on("pointer-move",o=>{const d=o.native.ctrlKey;s.enabledToggled!==d&&(s.enabledToggled=d,e())},a)];t.addHandles(l,r)}},k);t.addHandles(i)}(function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(q||(q={}));class Ct{constructor(e,i){this.isDraped=e,this.domain=i}}class ri extends Ct{constructor(e,i,n=H.ALL){super(i,n),this.intersectionPoint=e}equals(e){return e instanceof ri&&T(this.intersectionPoint,e.intersectionPoint)}}class U extends Ct{constructor(e,i,n,s,r=H.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=i,this.lineEnd=n,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof U&&this.type===e.type&&T(this.lineStart,e.lineStart)&&T(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return jt(this.lineStart,this.lineEnd)}}class ai extends Ct{constructor(e,i,n,s=H.ALL){super(n,s),this.lineStart=e,this.lineEnd=i}equals(e){return e instanceof ai&&T(this.lineStart,e.lineStart)&&T(this.lineEnd,e.lineEnd)}}class Yi extends Ct{constructor(e,i,n){super(i,n),this.point=e}equals(e){return e instanceof Yi&&T(this.point,e.point)}}class Ot extends Ct{constructor(e,i,n,s,r=H.ALL){super(s,r),this.previousVertex=e,this.centerVertex=i,this.nextVertex=n}equals(e){return e instanceof Ot&&T(this.previousVertex,e.previousVertex)&&T(this.centerVertex,e.centerVertex)&&T(this.nextVertex,e.nextVertex)}}class Ro{draw(e,i){const n=this._getUniqueHints(e),s=this.sortUniqueHints(n),r=[];for(const a of s)a instanceof ri&&r.push(this.visualizeIntersectionPoint(a,i)),a instanceof U&&r.push(this.visualizeLine(a,i)),a instanceof ai&&r.push(this.visualizeParallelSign(a,i)),a instanceof Ot&&r.push(this.visualizeRightAngleQuad(a,i)),a instanceof Yi&&r.push(this.visualizePoint(a,i));return Sr(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const i=[];for(const n of e){let s=!0;for(const r of i)if(n.equals(r)){s=!1;break}s&&i.push(n)}return i}}class Do extends Ro{sortUniqueHints(e){return e.sort((i,n)=>(n instanceof U?n.length:0)-(i instanceof U?i.length:0))}visualizeIntersectionPoint(e,i){const{spatialReference:n,view:s}=i;return je(new vn({view:s,primitive:"circle",geometry:Tn(e.intersectionPoint,n),elevationInfo:e.isDraped?yn:A,size:20,outlineSize:2,color:[0,0,0,0],outlineColor:E.toUnitRGBA(b.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{view:n,spatialReference:s}=i,r=this._alignPoint(e.point,e.domain,i);return je(new vn({view:n,primitive:"circle",geometry:Tn(r,s),elevationInfo:this._hintElevationInfo(e,i),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:E.toUnitRGBA(b.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{view:n,spatialReference:s}=i,r=this._alignPoint(e.lineStart,e.domain,i),a=this._alignPoint(e.lineEnd,e.domain,i);return je(this._createLineSegmentHint(e.type,r,a,s,this._hintElevationInfo(e,i),n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{view:n,spatialReference:s}=i,{isDraped:r}=e,a=this._hintElevationInfo(e,i),l=this._alignPoint(e.lineStart,e.domain,i),o=this._alignPoint(e.lineEnd,e.domain,i),d=Me(l,s,a,n,r),c=Me(o,s,a,n,r),u=Yn(c,d,c,.5),f=new Mo({view:n,attached:!1,offset:b.parallelLineHintOffset,length:b.parallelLineHintLength,width:b.parallelLineHintWidth,color:E.toUnitRGBA(b.orange),location:u,renderOccluded:r?x.OccludeAndTransparent:x.Opaque,isDraped:r,renderGroup:pi.SnappingHint});return f.setDirectionFromPoints(d,u),f.attached=!0,je(f)}visualizeRightAngleQuad(e,i){const{view:n,spatialReference:s}=i,r=this._hintElevationInfo(e,i),{isDraped:a}=e,l=this._alignPoint(e.previousVertex,e.domain,i),o=this._alignPoint(e.centerVertex,e.domain,i),d=this._alignPoint(e.nextVertex,e.domain,i),c=Me(l,s,r,n,a),u=Me(o,s,r,n,a),f=Me(d,s,r,n,a);return je(new va({view:n,attached:!0,color:a?E.toUnitRGBA(b.orangeTransparent):E.toUnitRGBA(b.orange),renderOccluded:a?x.OccludeAndTransparent:x.Transparent,outlineRenderOccluded:a?x.OccludeAndTransparent:x.Opaque,outlineColor:E.toUnitRGBA(b.orange),outlineSize:b.rightAngleHintOutlineSize,size:b.rightAngleHintSize,isDraped:a,geometry:{previous:c,center:u,next:f},renderGroup:pi.SnappingHint}))}_createLineSegmentHint(e,i,n,s,r,a,l=!1,o=!0,d=!0){const c=Me(i,s,r,a,l),u=Me(n,s,r,a,l),f=new xo({view:a,extensionType:J.FADED,start:c,end:u,isDraped:l,color:E.toUnitRGBA(b.orange),renderOccluded:l?x.OccludeAndTransparent:x.Opaque,renderGroup:pi.SnappingHint});switch(e){case q.TARGET:f.width=b.lineHintWidthTarget,f.fadedExtensions={start:0,end:b.lineHintFadedExtensions};break;case q.REFERENCE_EXTENSION:f.width=b.lineHintWidthReference,f.fadedExtensions={start:0,end:0};break;case q.REFERENCE:f.width=b.lineHintWidthReference,f.fadedExtensions={start:o?b.lineHintFadedExtensions:0,end:d?b.lineHintFadedExtensions:0}}return f.attached=!0,f}_alignPoint(e,i,n){const s=this._getSelfSnappingZ(i,n);return g(s)?e:$o(e[0],e[1],s)}_hintElevationInfo(e,i){return m(this._getSelfSnappingZ(e.domain,i))?Q(i.selfSnappingZ).elevationInfo:e.isDraped?yn:A}_getSelfSnappingZ(e,{selfSnappingZ:i}){return e===H.SELF&&m(i)?i.value:null}}function Me(t,e,i,n,s,r=y()){if(s){const a=n.basemapTerrain.overlayManager.renderer.spatialReference;kt(t,e,r,a)}else sa(t,e,i,n,r);return r}const v={main:new E([255,127,0]),selected:new E([255,255,255]),staged:new E([12,207,255]),outline:new E([0,0,0,.5]),selectedOutline:new E([255,255,255])},Ke=.3;function bt(t,e){const i=t.clone();return i.a*=e,i}function Ao(t,e){const i=t.clone(),n=Pr(i);n.s*=e;const s=xr(n);return i.r=s.r,i.g=s.g,i.b=s.b,i}function ee(t,e){if(e)for(const i in e)t[i]=e[i]}class Lo{constructor(e){this.color=v.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=x.Opaque,ee(this,e)}}class _i{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=v.main,this.outlineColor=v.outline,this.renderOccluded=x.Opaque,this.hoverOutlineColor=v.selectedOutline,ee(this,e)}apply(e,i){const n=this[e];i.setParameters({color:Pe(n),transparent:e!=="color"||n.a<1,renderOccluded:this.renderOccluded})}}class zo{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=bt(v.main,.5),this.hoverColor=v.main,this.renderOccluded=x.Transparent,this.minSquaredEdgeLength=900,ee(this,e)}apply(e,i){const n=this[e];i.setParameters({color:Pe(n),transparent:n.a<1,renderOccluded:this.renderOccluded})}}class Vo{constructor(e){this.vertex=new _i({color:v.main,outlineColor:v.outline}),this.edge=new _i({color:Ao(bt(v.main,2/3),.5),outlineColor:bt(v.outline,.5),size:8,collisionPadding:8}),this.selected=new _i({color:v.selected,outlineColor:v.outline}),this.edgeOffset=new zo,ee(this,e)}}class Ri{constructor(e){this.color=v.selected,this.width=1.5,this.stipplePattern=Le(5),this.stippleOffColor=v.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=v.selected,this.renderOccluded=x.OccludeAndTransparent,ee(this,e)}apply(e){e.color=Pe(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=Pe(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=Pe(this.innerColor),e.renderOccluded=this.renderOccluded}}class Ho{constructor(e){this.color=v.selected,this.size=4,this.outlineSize=1,this.outlineColor=v.outline,this.shape="square",ee(this,e)}apply(e){e.color=Pe(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=Pe(this.outlineColor),e.primitive=this.shape}}class Qt{constructor(e){this.innerColor=v.selected,this.innerWidth=1,this.glowColor=v.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=Ke,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=v.main,ee(this,e)}apply(e,i=1){const n={glowColor:E.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:E.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*i,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in e?e.style=n:e.laserlineStyle=n}}class Io{constructor(e){this.outline=new Ri({color:v.outline,renderOccluded:x.OccludeAndTransparentStencil,stippleOffColor:v.selected,stipplePattern:Le(5),width:1.5,innerWidth:0}),this.staged=new Ri({color:v.selected,renderOccluded:x.OccludeAndTransparentStencil,innerColor:v.staged,stippleOffColor:v.outline,stipplePattern:Le(5),width:1.5}),this.shadowStyle=new Qt({globalAlpha:Ke,glowColor:v.main,glowFalloff:8,glowWidth:8,innerColor:v.selected,innerWidth:1}),ee(this,e)}}class Go{constructor(e){this.outline=new Ho({color:v.selected,outlineColor:v.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new Qt({globalAlpha:Ke,glowColor:v.main,glowFalloff:1.5,glowWidth:6,innerColor:v.selected,innerWidth:1,radius:2}),ee(this,e)}}class Fo extends Ri{constructor(e){super(),this.extensionType=J.GROUND_RAY,ee(this,e)}}class No{constructor(e){this.lineGraphics=new Io,this.pointGraphics=new Go,this.heightPlane=new Qt({globalAlpha:Ke,glowColor:v.main,glowFalloff:8,glowWidth:8,innerColor:v.selected,innerWidth:1}),this.heightBox=new Qt({globalAlpha:Ke,glowColor:v.main,glowFalloff:8,glowWidth:8,innerColor:v.selected,innerWidth:0,heightFillColor:v.main}),this.zVerticalLine=new Fo({color:bt(v.main,5*Ke/3),falloff:2,innerColor:bt(v.selected,0),renderOccluded:x.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:J.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,ee(this,e)}}class ko{constructor(e){this.visualElements=new No,this.reshapeManipulators=new Vo,this.zManipulator=new Lo,ee(this,e)}colorToVec4(e){return Pe(e)}}function Pe(t){return wr(E.toUnitRGBA(t))}const ke=new ko;function jo(t,e,i,n,s){const r=pn(3*t.length),a=pn(r.length);t.forEach((d,c)=>{r[3*c+0]=d[0],r[3*c+1]=d[1],r[3*c+2]=d.length>2?d[2]:0});const l=br(r,e,0,a,0,r,0,r.length/3,i,n,s),o=l!=null;return{numVertices:t.length,position:r,mapPositions:a,projectionSuccess:o,sampledElevation:l}}class qo extends ts{constructor(e){super(e),this.view=null,this._renderOccluded=x.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=ke.colorToVec4(ke.reshapeManipulators.vertex.color),this._size=ke.reshapeManipulators.vertex.size,this._outlineColor=ke.colorToVec4(ke.reshapeManipulators.vertex.outlineColor),this._outlineSize=ke.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){Xe(e,this._color)||(vt(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){Xe(e,this._outlineColor)||(vt(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(g(e)||e.length===0)return[];const i=.5,n=.5,s=jo(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Mr.fromElevationInfo(this.elevationInfo)),r=[],a=s.numVertices,l=s.position;for(let o=0;o<a;++o){const d=me(Uo,l[3*o+0],l[3*o+1],l[3*o+2]),c=An(this._vertexMaterial,i,d),u=An(this._vertexOutlineMaterial,n,d);r.push({vertexGeometry:c,vertexOutlineGeometry:u})}return r}createGeometries(e){const i=this._createRenderGeometries();for(const{vertexGeometry:n,vertexOutlineGeometry:s}of i)e.addGeometry(n),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new _n({...this._vertexMaterialParameters,writeDepth:!0,cullFace:fn.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new _n({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:fn.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}}const Uo=y();function An(t,e,i){return Er(t,e,16,16,{offset:i})}let Oe=class extends ge{constructor(t){super(t),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};h([p({constructOnly:!0})],Oe.prototype,"layer",void 0),h([p()],Oe.prototype,"enabled",void 0),h([p()],Oe.prototype,"updating",void 0),h([p()],Oe.prototype,"availability",void 0),Oe=h([F("esri.views.interactive.snapping.FeatureSnappingLayerSource")],Oe);const Ms=Oe;let Z=class extends ge{constructor(t){super(t),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new rt,this.distance=b.distance,this.touchSensitivityMultiplier=b.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};h([p()],Z.prototype,"enabled",void 0),h([p()],Z.prototype,"enabledToggled",void 0),h([p()],Z.prototype,"selfEnabled",void 0),h([p()],Z.prototype,"featureEnabled",void 0),h([p({type:rt.ofType(Ms)})],Z.prototype,"featureSources",void 0),h([p()],Z.prototype,"distance",void 0),h([p()],Z.prototype,"touchSensitivityMultiplier",void 0),h([p({readOnly:!0})],Z.prototype,"effectiveEnabled",null),h([p({readOnly:!0})],Z.prototype,"effectiveSelfEnabled",null),h([p({readOnly:!0})],Z.prototype,"effectiveFeatureEnabled",null),Z=h([F("esri.views.interactive.snapping.SnappingOptions")],Z);const Es=Z;function Wo(t,e){var n,s;const i=new Es({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(n=e==null?void 0:e.distance)!=null?n:b.distance,touchSensitivityMultiplier:(s=e==null?void 0:e.touchSensitivityMultiplier)!=null?s:b.touchSensitivityMultiplier});return{...M(()=>{var r,a,l;return(l=(a=(r=t.map)==null?void 0:r.allLayers)==null?void 0:a.toArray())!=null?l:[]},r=>{i.featureSources=new rt(r.map(a=>new Ms({layer:a,enabled:!0})))},Bt),options:i}}function Di({start:t,end:e,type:i},n,s){const r=[],a=ce(Ie,e,t),l=ce(at,t,n),o=St(a),d=2*Et(a,l),c=d*d-4*o*(St(l)-s*s);if(c===0){const u=-d/(2*o);(i===ae.PLANE||u>=0)&&r.push(ft(re(),t,a,u))}else if(c>0){const u=Math.sqrt(c),f=(-d+u)/(2*o);(i===ae.PLANE||f>=0)&&r.push(ft(re(),t,a,f));const _=(-d-u)/(2*o);(i===ae.PLANE||_>=0)&&r.push(ft(re(),t,a,_))}return r}function Ai(t,e){const i=t.start,n=t.end,s=ce(Ie,n,i),r=me(at,-s[1],s[0],0),a=e.start,l=e.end,o=z(Ji,l,a),d=V(o,r),c=me(Ts,i[0],i[1],0),u=z(Rs,c,a),f=V(u,r);if(Math.abs(d)<ne)return[];const _=se(Ds,a,o,f/d);if(e.type===j.RAY){const S=z(ti,_,a);if(V(S,o)<-ne)return[]}if(t.type===ae.HALF_PLANE){const S=$r(ti,_,i);if(Et(S,s)<-ne)return[]}return[xe(_)]}function Li(t,e){return zi(ei(Ki,e[2],t),e)}function $s(t,e){const n=Os(ei(Ki,0,t),ei(Yo,0,e)),s=[];for(const r of n)s.push(Cr(r));return s}function Cs(t,e){return Xi(t,ei(Ki,t[2],e))}function Bo(t,e,i){const n=ce(Ie,t,e),s=i/Or(n),r=ft(y(),e,n,s);return r[2]=t[2],r}function Xi(t,{start:e,end:i,type:n}){const s=z(Ie,t,e),r=z(at,i,e),a=V(s,r)/V(r,r);return se(y(),e,r,n===j.RAY?Math.max(a,0):a)}function Ln({start:t,end:e,type:i},n,s){const r=[],a=st(Ie,e,t),l=ce(at,t,n),o=St(a),d=2*Et(a,l),c=d*d-4*o*(St(l)-s*s);if(c===0){const u=-d/(2*o);(i===j.LINE||u>=0)&&r.push(se(y(),t,a,u))}else if(c>0){const u=Math.sqrt(c),f=(-d+u)/(2*o);(i===j.LINE||f>=0)&&r.push(se(y(),t,a,f));const _=(-d-u)/(2*o);(i===j.LINE||_>=0)&&r.push(se(y(),t,a,_))}return r}function Os(t,e){const i=t.start,n=t.end,s=e.start,r=e.end,a=z(Ie,n,i),l=z(at,r,s),o=z(Ji,s,i),d=le(Ts,a,l),c=V(o,d);if(!Ei(c,0,ne))return[];const u=$i(d);if(Ei(u,0,ne))return[];const f=le(Rs,o,l),_=V(f,d)/u,S=se(Ds,i,a,_);if(t.type===j.RAY){const P=z(ti,S,i);if(V(a,P)<-ne)return[]}if(e.type===j.RAY){const P=z(ti,S,s);if(V(l,P)<-ne)return[]}return[xe(S)]}function zi({start:t,end:e,type:i},n){const s=z(Ie,n,t),r=z(at,e,t),a=le(Ji,r,s);if($i(a)/$i(r)<ne)switch(i){case j.LINE:return[xe(n)];case j.RAY:return V(r,s)<-ne?[]:[xe(n)]}return[]}function zn(t,e,i){return Ei(ze(i,t),e*e,ne)?[xe(i)]:[]}function ei(t,e,{start:i,end:n,type:s}){return me(t.start,i[0],i[1],e),me(t.end,n[0],n[1],e),t.type=Zo[s],t}var ae;(function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"})(ae||(ae={}));const Zo={[ae.PLANE]:j.LINE,[ae.HALF_PLANE]:j.RAY},ne=1e-6,Ie=y(),at=y(),Ji=y(),Ts=y(),Rs=y(),Ds=y(),ti=y(),Ki={start:y(),end:y(),type:j.LINE},Yo={start:y(),end:y(),type:j.LINE};class Ge{intersect(e){return Qo(this,e)}}class Xo extends Ge{constructor(e){super(),this.point=e}equals(e){return Ue(e)&&T(this.point,e.point)}closestTo(){return bs(this.point)}}class As extends Ge{constructor(e,i,n){super(),this.start=e,this.end=i,this.type=n,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return Re(e)&&this.type===e.type&&T(this.start,e.start)&&T(this.end,e.end)}closestTo(e){const i=Xi(e,this.lineLike);return i}}class Jo extends As{constructor(e,i){super(e,i,j.LINE)}}class oi extends Ge{constructor(e,i,n){super(),this.intersection=e,this.first=i,this.second=n}equals(e){return e instanceof oi&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return bs(this.intersection)}}class _t extends Ge{constructor(e,i,n){super(),this.basePoint=e,this.first=i,this.second=n}equals(e){return e instanceof _t&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const i=this.basePoint;return B(i[0],i[1],e[2])}}class Ls extends Ge{constructor(e,i){super(),this.center=e,this.radius=i}equals(e){return We(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const i=Bo(e,this.center,this.radius);return i}}class Qi extends Ge{constructor(e,i,n){super(),this.start=e,this.end=i,this.type=n,this.planeLike={start:e,end:i,type:n}}equals(e){return De(e)&&this.type===e.type&&T(this.start,e.start)&&T(this.end,e.end)}closestTo(e){return Cs(e,this.planeLike)}closestEndTo(e){const{start:i,end:n}=this;return Math.sign(Et(ce(tl,n,i),ce(il,e,i)))>0?n:i}}class zs extends Qi{constructor(e,i){super(e,i,ae.HALF_PLANE)}}class Vs extends Qi{constructor(e,i){super(e,i,ae.PLANE)}}class Hs extends Ge{constructor(e,i,n){super(),this.start=e,this.end=i,this.getZ=n,this.planeLike={start:e,end:i,type:ae.HALF_PLANE}}equals(e){return Ae(e)&&T(this.start,e.start)&&T(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Ko(this,e)}addIfOnTheGround(e,i){for(const n of i){const s=et(this.getZ(n[0],n[1],n[2]),0);Math.abs(n[2]-s)<ne&&(n[2]=s,e.push(n))}}}function Ko(t,e){var n;const i=Cs(e,t.planeLike);return i[2]=(n=we(t.getZ(e[0],e[1],e[2])))!=null?n:Is,i}function Qo(t,e){let i=[];if(Ue(t)){const{point:n}=t;Re(e)?i=zi(e.lineLike,n):We(e)?i=zn(e.center,e.radius,n):De(e)?i=Li(e.planeLike,n):Ae(e)&&(i=ct(e,t))}else if(Re(t)){const{lineLike:n}=t;Ue(e)?i=zi(n,e.point):Re(e)?i=Os(n,e.lineLike):We(e)?i=Ln(n,e.center,e.radius):De(e)?i=Ai(e.planeLike,n):Ae(e)&&(i=ct(e,t))}else if(We(t)){const{center:n,radius:s}=t;if(Re(e))i=Ln(e.lineLike,n,s);else if(Ue(e))i=zn(n,s,e.point);else{if(De(e))return Di(e.planeLike,n,s).map(r=>new _t(r,t,e));Ae(e)&&(i=ct(e,t))}}else if(De(t)){const{planeLike:n}=t;if(De(e))return $s(n,e.planeLike).map(s=>new _t(s,t,e));if(Ue(e))i=Li(n,e.point);else if(Re(e))i=Ai(n,e.lineLike);else{if(We(e))return Di(n,e.center,e.radius).map(s=>new _t(s,t,e));Ae(e)&&(i=ct(e,t))}}else Ae(t)&&(i=ct(t,e));return el(i,t,e)}function ct(t,e){var r;const{planeLike:i,getZ:n}=t,s=[];if(Ue(e))t.addIfOnTheGround(s,Li(i,e.point));else if(Re(e))t.addIfOnTheGround(s,Ai(i,e.lineLike));else if(We(e))for(const[a,l]of Di(i,e.center,e.radius)){const o=n(a,l,0);m(o)&&s.push(B(a,l,o))}else if(De(e)||Ae(e))for(const[a,l]of $s(i,e.planeLike)){const o=(r=we(n(a,l,0)))!=null?r:Is;s.push(B(a,l,o))}return s}function el(t,e,i){return t.map(n=>new oi(n,e,i))}function Ue(t){return t instanceof Xo}function Re(t){return t instanceof As}function We(t){return t instanceof Ls}function De(t){return t instanceof Qi}function Ae(t){return t instanceof Hs}const tl=re(),il=re(),Is=0;class ot{constructor(e,i,n,s){this.targetPoint=e,this.constraint=i,this.isDraped=n,this.domain=s}}class en extends ot{constructor({targetPoint:e,objectId:i,constraint:n,isDraped:s}){super(e,n,s,H.FEATURE),this.objectId=i}}class nl extends en{constructor(e){super({...e,isDraped:!0,constraint:new Hs(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new U(q.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}class sl extends en{constructor(e){super({...e,constraint:new Jo(e.edgeStart,e.edgeEnd)})}get hints(){return[new U(q.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}}class Gs extends ot{constructor({targetPoint:e,constraint:i,previousVertex:n,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,i,l,H.SELF),this.previousVertex=n,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,i=this.otherVertexType===nt.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===nt.CENTER?this.targetPoint:this.otherVertex;return[new U(q.TARGET,i,n,this.isDraped,this.domain),new U(q.REFERENCE,e,i,this.isDraped,this.domain),new Ot(this.previousVertex,i,n,this.isDraped,this.domain)]}}var nt;(function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"})(nt||(nt={}));let he=class extends Ii{get updating(){return Tr(this.snappingSources,({snappingSource:t})=>t.updating)||this.updatingHandles.updating}get snappingSources(){const t=this._get("snappingSources")||new Map,e=new Map;if(m(this.options)&&m(this.options.featureSources))for(const i of this.options.featureSources.items){const n=i.layer.uid,s=t.get(n);if(s){t.delete(n),e.set(n,s);continue}if(!i.layer.loaded){this.updatingHandles.addPromise(i.layer.load());continue}const r=this._createSourceInfo(i);m(r)&&e.set(n,r)}for(const[,i]of t)i.destroy();return e}constructor(t){super(t),this.options=null,this._domain=H.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),it),m(this.view)&&this.handles.add([this.view.on("layerview-create",t=>this._updateLayerView(t.layer,t.layerView)),this.view.on("layerview-destroy",t=>this._updateLayerView(t.layer,null))])}_updateLayerView(t,e){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===t&&(i.layerView=e)}destroy(){this._set("options",null);for(const[,t]of this.snappingSources)t.destroy()}async fetchCandidates(t,e,i,n){var o,d;if(!(e&this._domain)||g(this.options)||!this.options.effectiveFeatureEnabled)return[];const s=[],r=this._computeScreenSizeDistanceParameters(t,i),a={distance:r,mode:(d=(o=Q(this.view))==null?void 0:o.type)!=null?d:"2d",point:t,coordinateHelper:i.coordinateHelper,types:this._types};for(const[,{snappingSource:c,layerView:u}]of this.snappingSources)!c.layerSource.enabled||m(u)&&u.suspended||s.push(c.fetchCandidates(a,n).then(f=>f.filter(_=>!this._candidateIsExcluded(c,_,i.excludeFeature))));const l=(await Rr(s)).flat();return this._addRightAngleCandidates(l,t,r,i),Dr(n),Zi(t,l),l}_addRightAngleCandidates(t,e,i,n){var c,u,f,_,S,P,w,L;const s=m(n.vertexHandle)?(u=(c=n.vertexHandle.rightEdge)==null?void 0:c.rightVertex)==null?void 0:u.pos:m(n.editGeometryOperations)&&n.editGeometryOperations.data.type==="polygon"?(_=Q((f=n.editGeometryOperations.data.components[0])==null?void 0:f.getFirstVertex()))==null?void 0:_.pos:null,r=m(n.vertexHandle)?(P=(S=n.vertexHandle.leftEdge)==null?void 0:S.leftVertex)==null?void 0:P.pos:m(n.editGeometryOperations)?(L=Q((w=n.editGeometryOperations.data.components[0])==null?void 0:w.getLastVertex()))==null?void 0:L.pos:null,{view:a}=this,l=O(s,a,n),o=O(r,a,n),d=t.length;for(let _e=0;_e<d;_e++)this._addRightAngleCandidate(t[_e],o,e,i,t),this._addRightAngleCandidate(t[_e],l,e,i,t)}_addRightAngleCandidate(t,e,i,n,s){if(g(e)||!al(t))return;const r=t.constraint.closestTo(e),a=(r[0]-i[0])/n.x,l=(r[1]-i[1])/n.y,{start:o,end:d}=t.constraint;if(a*a+l*l<=1){const c=new Gs({targetPoint:r,otherVertex:e,otherVertexType:nt.NEXT,previousVertex:ze(r,o)>ze(r,d)?o:d,constraint:new zs(e,r),objectId:t.objectId,isDraped:t.isDraped});s.push(c)}}_computeScreenSizeDistanceParameters(t,e){let i=m(this.options)?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return g(this.view)?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(t,i,this.view,e)}_computeScreenSizeDistanceParameters3D(t,e,i,n){const{spatialReference:s}=n;i.renderCoordsHelper.toRenderCoords(t,s,Vn);const r=i.state.camera.computeScreenPixelSizeAt(Vn),a=r*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,l=e*a,o=G(t,s,A,i),d=o?yi(o,t,a,0,0,i,n):0,c=o?yi(o,t,0,a,0,i,n):0,u=o?yi(o,t,0,0,a,i,n):0;return{x:d===0?0:l/d,y:c===0?0:l/c,z:u===0?0:l/u,distance:r*e}}get _types(){return Sn.EDGE|Sn.VERTEX}_candidateIsExcluded(t,e,i){if(g(i))return!1;const n=this._getCandidateObjectId(e);if(g(n))return!1;const s=t.layerSource.layer;return s.type==="graphics"?i.uid===n:i.sourceLayer===s&&!(!i.attributes||!("objectIdField"in s))&&i.attributes[s.objectIdField]===n}_getCandidateObjectId(t){return t instanceof en?t.objectId:null}_createSourceInfo(t){const e=this._createFeatureSnappingSourceType(t);if(g(e))return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const i=m(this.view)?this.view.allLayerViews.find(n=>n.layer===t.layer):null;return new rl(e.source,i)}_createFeatureSnappingSourceType(t){switch(t.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(t);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(t);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(t);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(t)}return null}_createFeatureSnappingSourceSceneLayer(t){const{view:e}=this;if(g(e)||e.type!=="3d")return null;const i=this._getSourceModule("scene");return m(i.module)?{source:new i.module.SceneLayerSnappingSource({layerSource:t,view:e})}:{loading:i.loader}}_createFeatureSnappingSourceFeatureLayer(t){var e;switch((e=t.layer.source)==null?void 0:e.type){case"feature-layer":case"oriented-imagery":{const i=this._getSourceModule("featureService");return m(i.module)?{source:new i.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:i.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(t.layer.geometryType==="mesh")return null;const i=this._getSourceModule("featureCollection");return m(i.module)?{source:new i.module.FeatureCollectionSnappingSource({layerSource:t,view:this.view})}:{loading:i.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(t){const e=this._getSourceModule("graphics");return m(e.module)?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>[t.layer],spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}_createFeatureSnappingSourceMapNotesLayer(t){const e=this._getSourceModule("notes");return m(e.module)?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>m(t.layer.sublayers)?t.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}_getSourceModule(t){const e=this._sourceModules[t];if(g(e.loader)){const i=this._loadSourceModule(t).then(n=>{e.module=n});return e.loader=i,{module:e.module,loader:i}}return{module:e.module,loader:e.loader}}_loadSourceModule(t){const e=this.updatingHandles;switch(t){case"featureService":return e.addPromise(Rt(()=>import("./FeatureServiceSnappingSource.89b4baf3.js"),["assets/FeatureServiceSnappingSource.89b4baf3.js","assets/index.f0143bd6.js","assets/index.574508c2.css","assets/elevationInfoUtils.7e7fe510.js","assets/queryEngineUtils.26947f5a.js","assets/VertexSnappingCandidate.06c9a260.js","assets/TileTreeDebugger.cd2ed121.js","assets/LineVisualElement.de7495a8.js","assets/LengthDimension.d9211558.js","assets/Segment.ee3be1e9.js","assets/analysisViewUtils.c00d3a5f.js","assets/ImageMaterial.3510e1f9.js","assets/Factory.1ef4d713.js","assets/RightAngleQuadVisualElement.5660a418.js","assets/VisualElementResources.634ef0b5.js","assets/PointVisualElement.edb3ccda.js","assets/EditGeometryOperations.89e2c385.js","assets/QueryEngineResult.d691c7bb.js","assets/WhereClause.48310df0.js","assets/executionError.c4c51b90.js","assets/utils.ecbb20c7.js","assets/generateRendererUtils.fcfe376e.js","assets/json.5152e73f.js","assets/dehydratedFeatureComparison.13f4f597.js","assets/RenderTexture.a7d6a19a.js"]));case"featureCollection":return e.addPromise(Rt(()=>import("./FeatureCollectionSnappingSource.e81aace8.js"),["assets/FeatureCollectionSnappingSource.e81aace8.js","assets/index.f0143bd6.js","assets/index.574508c2.css","assets/elevationInfoUtils.7e7fe510.js","assets/queryEngineUtils.26947f5a.js","assets/VertexSnappingCandidate.06c9a260.js","assets/symbologySnappingCandidates.75390873.js","assets/LineVisualElement.de7495a8.js","assets/LengthDimension.d9211558.js","assets/Segment.ee3be1e9.js","assets/analysisViewUtils.c00d3a5f.js","assets/ImageMaterial.3510e1f9.js","assets/Factory.1ef4d713.js","assets/RightAngleQuadVisualElement.5660a418.js","assets/VisualElementResources.634ef0b5.js","assets/PointVisualElement.edb3ccda.js","assets/EditGeometryOperations.89e2c385.js","assets/QueryEngineResult.d691c7bb.js","assets/WhereClause.48310df0.js","assets/executionError.c4c51b90.js","assets/utils.ecbb20c7.js","assets/generateRendererUtils.fcfe376e.js","assets/json.5152e73f.js","assets/dehydratedFeatureComparison.13f4f597.js","assets/RenderTexture.a7d6a19a.js"]));case"graphics":case"notes":return e.addPromise(Rt(()=>import("./GraphicsSnappingSource.e41bfca8.js"),["assets/GraphicsSnappingSource.e41bfca8.js","assets/index.f0143bd6.js","assets/index.574508c2.css","assets/normalizeUtilsSync.02940ef6.js","assets/FeatureStore.368a7cb3.js","assets/BoundsStore.d65199ec.js","assets/PooledRBush.3515f326.js","assets/quickselect.2c5f2780.js","assets/optimizedFeatureQueryEngineAdapter.80f55770.js","assets/centroid.869e75fe.js","assets/QueryEngineResult.d691c7bb.js","assets/WhereClause.48310df0.js","assets/executionError.c4c51b90.js","assets/utils.ecbb20c7.js","assets/generateRendererUtils.fcfe376e.js","assets/json.5152e73f.js","assets/QueryEngine.5f539ff5.js","assets/QueryEngineCapabilities.ea616409.js","assets/elevationInfoUtils.7e7fe510.js","assets/queryEngineUtils.26947f5a.js","assets/VertexSnappingCandidate.06c9a260.js","assets/symbologySnappingCandidates.75390873.js","assets/LineVisualElement.de7495a8.js","assets/LengthDimension.d9211558.js","assets/Segment.ee3be1e9.js","assets/analysisViewUtils.c00d3a5f.js","assets/ImageMaterial.3510e1f9.js","assets/Factory.1ef4d713.js","assets/RightAngleQuadVisualElement.5660a418.js","assets/VisualElementResources.634ef0b5.js","assets/PointVisualElement.edb3ccda.js","assets/EditGeometryOperations.89e2c385.js","assets/dehydratedFeatureComparison.13f4f597.js","assets/RenderTexture.a7d6a19a.js"]));case"scene":return e.addPromise(Rt(()=>import("./SceneLayerSnappingSource.844c30fe.js"),["assets/SceneLayerSnappingSource.844c30fe.js","assets/index.f0143bd6.js","assets/index.574508c2.css","assets/VertexSnappingCandidate.06c9a260.js","assets/LineVisualElement.de7495a8.js","assets/LengthDimension.d9211558.js","assets/Segment.ee3be1e9.js","assets/elevationInfoUtils.7e7fe510.js","assets/analysisViewUtils.c00d3a5f.js","assets/ImageMaterial.3510e1f9.js","assets/Factory.1ef4d713.js","assets/RightAngleQuadVisualElement.5660a418.js","assets/VisualElementResources.634ef0b5.js","assets/PointVisualElement.edb3ccda.js","assets/EditGeometryOperations.89e2c385.js","assets/QueryEngineResult.d691c7bb.js","assets/WhereClause.48310df0.js","assets/executionError.c4c51b90.js","assets/utils.ecbb20c7.js","assets/generateRendererUtils.fcfe376e.js","assets/json.5152e73f.js","assets/dehydratedFeatureComparison.13f4f597.js","assets/RenderTexture.a7d6a19a.js"]))}}};h([p({constructOnly:!0})],he.prototype,"spatialReference",void 0),h([p({constructOnly:!0})],he.prototype,"view",void 0),h([p()],he.prototype,"options",void 0),h([p({readOnly:!0})],he.prototype,"updating",null),h([p({readOnly:!0})],he.prototype,"snappingSources",null),he=h([F("esri.views.interactive.snapping.FeatureSnappingEngine")],he);class rl{constructor(e,i){this.snappingSource=e,this.layerView=i,this.handles=new ii;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([M(()=>e.updating,s=>e.layerSource.updating=s,k),M(()=>e.availability,s=>e.layerSource.availability=s,k)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}function al(t){return(t instanceof sl||t instanceof nl)&&!ol(t)}function ol({constraint:{start:t,end:e}}){const i=Mi(t,e),n=ze(t,e);return i<Ar()||n/i<dl}function yi(t,e,i,n,s,r,{spatialReference:a}){const l=I(ll,e);l[0]+=i,l[1]+=n,l[2]+=s;const o=G(l,a,A,r);return o?Oo(o,t):1/0}const Vn=y(),ll=y(),dl=1e-4;class li{constructor(e,i){this.view=e,this.options=i,this.squaredShortLineThreshold=b.shortLineThreshold*b.shortLineThreshold}snap(e,i){return m(i.vertexHandle)?i.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,i):this.snapNewVertex(e,i)}edgeExceedsShortLineThreshold(e,i){return this.exceedsShortLineThreshold(O(e.leftVertex.pos,this.view,i),O(e.rightVertex.pos,this.view,i),i)}exceedsShortLineThreshold(e,i,{spatialReference:n}){return this.squaredShortLineThreshold===0||He(G(i,n,A,this.view),G(e,n,A,this.view))>this.squaredShortLineThreshold}isVertical(e,i){return ze(e,i)<b.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:i}=this.options,n=e*i;return n*n}}class cl extends ot{constructor({lineStart:e,lineEnd:i,targetPoint:n,isDraped:s}){super(n,new Vs(e,i),s,H.SELF),this._referenceLineHint=new U(q.REFERENCE_EXTENSION,e,i,s,this.domain)}get hints(){return[this._referenceLineHint,new U(q.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}}class hl extends li{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=i,l=G(e,a,A,this.view),{view:o}=this,d=n.edges[s-1];let c=d;do{if(this.edgeExceedsShortLineThreshold(c,i)){const u=Kt(c,o,i);this._processCandidateProposal(u.left,u.right,e,l,i,r)}c=c.leftVertex.leftEdge}while(c&&c!==d);return r}snapExistingVertex(e,i){const n=[],s=Q(i.vertexHandle),r=s.component;if(r.edges.length<2)return n;const{view:a}=this,{spatialReference:l}=i,o=G(e,l,A,a),d=s.leftEdge,c=s.rightEdge;d&&c&&this.edgeExceedsShortLineThreshold(d,i)&&this.edgeExceedsShortLineThreshold(c,i)&&this._processCandidateProposal(O(d.leftVertex.pos,a,i),O(c.rightVertex.pos,a,i),e,o,i,n);const u=r.edges[0];let f=u;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,i)){const _=Kt(f,a,i);this._processCandidateProposal(_.left,_.right,e,o,i,n)}f=f.rightVertex.rightEdge}while(f&&f!==u);return n}_processCandidateProposal(e,i,n,s,r,a){var c;const{spatialReference:l,pointer:o}=r,d=Xi(n,{start:e,end:i,type:j.LINE});He(s,G(d,l,A,this.view))<this.squaredProximityThreshold(o)&&a.push(new cl({lineStart:e,lineEnd:i,targetPoint:d,isDraped:((c=r.elevationInfo)==null?void 0:c.mode)==="on-the-ground"}))}}class ul extends ot{constructor({referenceLine:e,lineStart:i,targetPoint:n,isDraped:s}){const r=xe(i),{left:a,right:l}=e;st(r,Wn(r,r,l),a),super(n,new Vs(i,r),s,H.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new U(q.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new ai(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new U(q.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const i={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{T(e.right,n.edge.left)&&(n.fadeLeft=!1,i.fadeRight=!1),T(e.right,n.edge.right)&&(n.fadeRight=!1,i.fadeRight=!1),T(e.left,n.edge.right)&&(n.fadeRight=!1,i.fadeLeft=!1),T(e.left,n.edge.left)&&(n.fadeLeft=!1,i.fadeLeft=!1)}),this._referenceLines.push(i)}}class pl extends li{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=G(e,i.spatialReference,A,l),d=O(n.vertices[r-1].pos,l,i),c=O(n.vertices[0].pos,l,i),u=n.edges[s-1];let f=u;do{if(this.edgeExceedsShortLineThreshold(f,i)){const _=Kt(f,l,i);this._checkEdgeForParallelLines(_,d,e,o,i,a),this._checkEdgeForParallelLines(_,c,e,o,i,a)}f=f.leftVertex.leftEdge}while(f&&f!==u);return a}snapExistingVertex(e,i){const n=[],s=Q(i.vertexHandle),r=s.component;if(r.edges.length<3)return n;const{view:a}=this,l=G(e,i.spatialReference,A,a),o=s.leftEdge,d=s.rightEdge,c=r.vertices[0],u=O(c.pos,a,i),f=r.vertices.length,_=r.vertices[f-1],S=O(_.pos,a,i),P=r.edges[0];let w=P;do{if(w!==o&&w!==d&&this.edgeExceedsShortLineThreshold(w,i)){const L=Kt(w,a,i);o&&this._checkEdgeForParallelLines(L,O(o.leftVertex.pos,a,i),e,l,i,n),d&&this._checkEdgeForParallelLines(L,O(d.rightVertex.pos,a,i),e,l,i,n),s===c?this._checkEdgeForParallelLines(L,S,e,l,i,n):s===_&&this._checkEdgeForParallelLines(L,u,e,l,i,n)}w=w.rightVertex.rightEdge}while(w&&w!==P);return n}_checkEdgeForParallelLines(e,i,n,s,r,a){var f;const l=e.left,o=e.right;if(fi(Ee,i,l,o),ze(Ee,i)<b.parallelLineThreshold)return;fi(Ee,n,l,o,i);const{spatialReference:d,pointer:c}=r,u=B(Ee[0],Ee[1],n[2]);if(He(s,G(u,d,A,this.view))<this.squaredProximityThreshold(c)){if(this.isVertical(u,i)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new ul({referenceLine:e,lineStart:i,targetPoint:u,isDraped:((f=r.elevationInfo)==null?void 0:f.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,i){const n=e.left,s=e.right;for(const r of i)if(fi(Ee,s,r.constraint.start,r.constraint.end,n),ze(Ee,s)<b.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}const Ee=re();class fl extends li{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=G(e,i.spatialReference,A,a),o=n.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,i)){const c=O(o.pos,a,i),u=O(o.leftEdge.leftVertex.pos,a,i);this._checkForSnappingCandidate(r,u,c,e,l,i)}const d=n.vertices[0];if(this.edgeExceedsShortLineThreshold(d.rightEdge,i)){const c=O(d.pos,a,i),u=O(d.rightEdge.rightVertex.pos,a,i);this._checkForSnappingCandidate(r,u,c,e,l,i)}return r}snapExistingVertex(e,i){const n=[],s=Q(i.vertexHandle);if(s.component.vertices.length<3)return n;const{view:r}=this,a=G(e,i.spatialReference,A,r),l=s.leftEdge,o=s.rightEdge;if(l&&l.leftVertex.leftEdge){const d=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(d,i)){const c=O(d.rightVertex.pos,r,i),u=O(d.leftVertex.pos,r,i);this._checkForSnappingCandidate(n,u,c,e,a,i)}}if(o&&o.rightVertex.rightEdge){const d=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(d,i)){const c=O(d.leftVertex.pos,r,i),u=O(d.rightVertex.pos,r,i);this._checkForSnappingCandidate(n,u,c,e,a,i)}}return n}_checkForSnappingCandidate(e,i,n,s,r,a){var f;const{spatialReference:l,pointer:o}=a;ce(Gt,n,i);const d=me(ml,Gt[1],-Gt[0],0),c=Et(d,ce(Gt,s,n))/St(d),u=ft(xe(s),n,d,c);if(He(r,G(u,l,A,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(u,n)||this.isVertical(n,i))return;const _=se(y(),n,d,Math.sign(c));e.push(new Gs({targetPoint:u,constraint:new zs(n,_),previousVertex:i,otherVertex:n,otherVertexType:nt.CENTER,isDraped:((f=a.elevationInfo)==null?void 0:f.mode)==="on-the-ground"}))}}}const Gt=re(),ml=y();class gl extends ot{constructor({targetPoint:e,point1:i,point2:n,isDraped:s}){super(e,new Ls(Yn(y(),i,n,.5),.5*Xn(i,n)),s,H.SELF),this._p1=i,this._p2=n}get hints(){return[new U(q.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new U(q.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new Ot(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}}class _l extends li{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(i.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=n.vertices[0],o=n.vertices[r-1],d=O(l.pos,a,i),c=O(o.pos,a,i);return this._processCandidateProposal(d,c,e,i,s),s}snapExistingVertex(e,i){const n=[],s=Q(i.vertexHandle),r=s.component;if(r.edges.length<2||i.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return n;const{view:a}=this,l=O(s.leftEdge.leftVertex.pos,a,i),o=O(s.rightEdge.rightVertex.pos,a,i);return this._processCandidateProposal(l,o,e,i,n),n}_processCandidateProposal(e,i,n,s,r){var _;if(!this.exceedsShortLineThreshold(e,i,s))return;const a=Lr(yl,e,i,.5),l=.5*Xn(e,i),o=y();Pa(o,n,a,l),o[2]=n[2];const d=o,{spatialReference:c,pointer:u}=s,f=G(n,c,A,this.view);if(He(f,G(d,c,A,this.view))<this.squaredProximityThreshold(u)){if(this.isVertical(e,d)||this.isVertical(d,i))return;r.push(new gl({targetPoint:d,point1:e,point2:i,isDraped:((_=s.elevationInfo)==null?void 0:_.mode)==="on-the-ground"}))}}}const yl=re();let qe=class extends ge{constructor(t){super(t),this.updating=!1,this._snappers=new rt,this._domain=H.SELF}initialize(){this._snappers.push(new pl(this.view,this.options),new hl(this.view,this.options),new fl(this.view,this.options),new _l(this.view,this.options))}set options(t){this._set("options",t);for(const e of this._snappers)e.options=t}async fetchCandidates(t,e,i){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const n=[];for(const s of this._snappers.items)for(const r of s.snap(t,i))n.push(r);return Zi(t,n),n}};h([p({readOnly:!0})],qe.prototype,"updating",void 0),h([p({constructOnly:!0})],qe.prototype,"view",void 0),h([p()],qe.prototype,"options",null),qe=h([F("esri.views.interactive.snapping.SelfSnappingEngine")],qe);function vl(t,e){return[new qe({view:t,options:e}),new he({view:t,options:e,spatialReference:t.spatialReference})]}class Ft extends ot{constructor(e,i,n,s){super(e,new oi(e,i.constraint,n.constraint),s,H.ALL),this.first=i,this.second=n}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new ri(this.targetPoint,this.isDraped,this.domain)]}}let te=class extends zr.EventedMixin(Ii){constructor(t){super(t),this.options=new Es,this.snappingEnginesFactory=vl,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ue.MAIN}initialize(){this.handles.add([M(()=>{const{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:n}=this.options;return{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:n}},()=>{this.doneSnapping(),this.emit("changed")},it),M(()=>this.options,t=>{for(const e of this._engines)e.options=t},it),M(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:t,snappingEnginesFactory:e})=>this._recreateEngines(t,e),k)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)}_recreateEngines(t,e){if(this._destroyEngines(),!t)return;const{view:i,options:n}=this;this._engines=e(i,n)}_destroyEngines(){for(const t of this._engines)t.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,i=t*e;return i*i}get _squaredSatisfiesConstraintThreshold(){return b.satisfiesConstraintScreenThreshold*b.satisfiesConstraintScreenThreshold}async snap(t){return Sl(t)?this._snapMultiPoint(t):this._snapSinglePoint(t)}update(t){const{point:e,context:i}=t;this._removeVisualization();const n=this._currentMainCandidate;if(g(n))return e;const s=this._selectUpdateInput(t);if(g(s))return e;const{spatialReference:r}=i,a=mn(s,r);if(g(a))return e;const{view:l}=this,{elevationInfo:o,visualizer:d}=i,c=[],u=ht(a,l,i),f=n.constraint.closestTo(u);if(!this._arePointsWithinScreenThreshold(u,f,i))return this._resetSnappingState(),e;n.targetPoint=f,c.push(...n.hints);for(const _ of this._currentOtherActiveCandidates)_.targetPoint=f,c.push(..._.hints);return m(d)&&this.handles.add(d.draw(c,{spatialReference:r,elevationInfo:wl(i),view:l,selfSnappingZ:i.selfSnappingZ}),Nt),On(f,l,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:o})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:t,scenePoint:e}){switch(this._currentSnappedType){case ue.MAIN:return t;case ue.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=ue.MAIN}_removeVisualization(){this.handles.remove(Nt)}async _snapSinglePoint({point:t,context:e,signal:i}){const{view:n}=this,s=ht(t,n,e),r=await this._fetchCandidates(s,H.ALL,e,i);return this._createSnapResult(s,ue.MAIN,r,n,e,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:e.elevationInfo},i)}async _snapMultiPoint({point:t,scenePoint:e,context:i,signal:n}){var f,_;const{view:s}=this,{coordinateHelper:r,spatialReference:a}=i;await Vr(e.spatialReference,a);const l=mn(e,a),o=ht(l,s,i),d=await this._fetchCandidates(o,H.FEATURE,i,n);if(d.length>0){const S=await this._fetchCandidates(o,H.SELF,i,n);return this._createSnapResult(o,ue.SCENE,[...d,...S],s,i,{z:l.z,m:l.m,spatialReference:l.spatialReference,elevationInfo:i.elevationInfo},n)}const c=ht(t,s,i),u=await this._fetchCandidates(c,H.SELF,i,n);return this._createSnapResult(c,ue.MAIN,u,s,i,{z:r.hasZ()&&t.hasZ?(f=t.z)!=null?f:0:void 0,m:r.hasM()&&t.hasM?(_=t.m)!=null?_:0:void 0,spatialReference:t.spatialReference,elevationInfo:i.elevationInfo},n)}async _fetchCandidates(t,e,i,n){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(t,e,i,n)))).flat()}_createSnapResult(t,e,i,n,s,r,a){return{get valid(){return!Hr(a)},apply:()=>{const{spatialReference:l}=s,{snappedPoint:o,hints:d}=this._processCandidates(t,e,i,s);return this._removeVisualization(),m(s.visualizer)&&this.handles.add(s.visualizer.draw(d,{spatialReference:l,elevationInfo:A,view:n,selfSnappingZ:s.selfSnappingZ}),Nt),On(o,n,r)}}}_processCandidates(t,e,i,n){if(i.length<1)return this.doneSnapping(),{snappedPoint:t,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),Zi(t,i);const s=this._currentMainCandidate;if(m(s)){const r=this._findOldConstraintInNewCandidates(s,i);if(r>=0){if(!(i[r]instanceof Ft))return this._intersectWithOtherCandidates(r,i,t,e,n);if(this._arePointsWithinScreenThreshold(t,s.targetPoint,n))return this._updateSnappingCandidate(s,e,i,n)}}return this._intersectWithOtherCandidates(0,i,t,e,n)}_findOldConstraintInNewCandidates(t,e){return t instanceof Ft?this._findOldCandidateIndex(e,t.first)>=0&&this._findOldCandidateIndex(e,t.second)>=0?0:-1:this._findOldCandidateIndex(e,t)}_intersectWithOtherCandidates(t,e,i,n,s){const{coordinateHelper:r}=s,a=e[t],l=[];for(let o=0;o<e.length;++o){if(o===t)continue;const d=e[o];for(const c of a.constraint.intersect(d.constraint)){const u=c.closestTo(a.targetPoint);l.push([new Ft(u,a,d,d.isDraped),this._squaredScreenDistance(i,u,r)])}}return l.length>0&&(l.sort((o,d)=>o[1]-d[1]),l[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(l[0][0],n,e,s):this._updateSnappingCandidate(a,n,e,s)}_updateSnappingCandidate(t,e,i,n){this.doneSnapping(),this._currentMainCandidate=t,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...t.hints);for(const a of i){if(t instanceof Ft){if(a.constraint.equals(t.first.constraint)||a.constraint.equals(t.second.constraint))continue}else if(a.constraint.equals(t.constraint))continue;const l=a.constraint.closestTo(s);this._squaredScreenDistance(l,s,n.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(a.targetPoint=s,this._currentOtherActiveCandidates.push(a),r.push(...a.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(t){return t==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(t,e,i){return this._squaredScreenDistance(t,e,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(t,e,i){return He(this._toScreen(t,i),this._toScreen(e,i))}_toScreen(t,e){return G(t,e.spatialReference,A,this.view)}_findOldCandidateIndex(t,e){let i=-1;for(let n=0;n<t.length;++n)if(e.constraint.equals(t[n].constraint)){i=n;break}return i}get test(){return{visualizationsActive:this.handles.has(Nt),engines:this._engines}}};var ue;h([p({constructOnly:!0})],te.prototype,"view",void 0),h([p()],te.prototype,"options",void 0),h([p({readOnly:!0})],te.prototype,"updating",null),h([p()],te.prototype,"snappingEnginesFactory",void 0),h([p()],te.prototype,"_engines",void 0),h([p()],te.prototype,"_squaredMouseProximityTreshold",null),h([p()],te.prototype,"_squaredTouchProximityThreshold",null),h([p()],te.prototype,"_squaredSatisfiesConstraintThreshold",null),te=h([F("esri.views.interactive.snapping.SnappingManager")],te),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(ue||(ue={}));const Nt="visualization-handle";function Sl(t){return m(t.scenePoint)}function wl({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?A:e}const qt=new Map;function Pl(t){if(!qt.has(t)){const n=Wo(t,{distance:10}),s=bl(t,n.options);qt.set(t,{referenceCount:0,snappingManager:s,remove:()=>{n.remove(),s.destroy()}})}const e=qt.get(t);e.referenceCount++;const i=Zt(()=>xl(t,e));return{snappingManager:e.snappingManager,...i}}function xl(t,e){e.referenceCount--,e.referenceCount>0||Ir(()=>{e.referenceCount===0&&(e.remove(),qt.delete(t))})}function bl(t,e){return new te({view:t,options:e,snappingEnginesFactory:(i,n)=>[new he({view:t,spatialReference:t.spatialReference,options:n})]})}class Fs{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function Ml({predicate:t=()=>!0,snappingManager:e,snappingContext:i,updatingHandles:n,useZ:s=!0}){const r=new rs;if(g(e))return{snappingStep:[Hn,r],cancelSnapping:Hn};let a,l=null,o=null,d=null;const c=()=>{l=wt(l),e.doneSnapping(),m(o)&&o.frameTask.remove(),o=null,a=Gi(a),d=null},u=El(e,s,r);let f=null,_=null,S=null;return{snappingStep:[P=>{if(!t(P))return P;const{action:w}=P;if(w==="start"){const{info:L}=P,_e=$l(e.view);if(o=Cl(i,P,_e),o.context.selfSnappingZ=null,!s&&m(L)){const lt=Tl(i.coordinateHelper,L.handle.component);m(lt)&&(o.context.selfSnappingZ={value:lt,elevationInfo:i.elevationInfo})}}if(m(o)){const{context:L,originalScenePos:_e,originalPos:lt}=o,{mapEnd:tn,mapStart:nn,scenePoints:js}=P,di=Ns(lt,Vi(tn,nn)),sn=Vi(nn,lt),qs={...P,action:"update"},Us=o.context,ci=Ol(_e,js),rn=e.update({point:di,scenePoint:ci,context:L});if(S=rn,ks(tn,rn,sn,s),f=di,_=ci,w!=="end"){const{frameTask:Ws}=o;g(l)&&(l=new AbortController),d=Bs=>{n.addPromise(Ci(u({frameTask:Ws,event:qs,context:Us,point:di,scenePoint:ci,delta:sn,getLastState:()=>({point:f,scenePoint:_,updatePoint:Bs.forceUpdate?null:S})},Q(l).signal)))},d({forceUpdate:!1}),g(a)&&(a=M(()=>e.options.effectiveEnabled,()=>d==null?void 0:d({forceUpdate:!0})))}}return w==="end"&&c(),P},r],cancelSnapping:P=>(c(),P)}}function El(t,e,i){return Qn(async({frameTask:n,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:d},c)=>{const u=await n.schedule(()=>t.snap({point:s,scenePoint:r,context:a,signal:c}),c);if(u.valid){let f=await n.schedule(()=>u.apply(),c);const _=d();m(_.point)&&s!==_.point&&(f=t.update({point:_.point,scenePoint:_.scenePoint,context:a})),!g(_.updatePoint)&&Ea(f,_.updatePoint)||(ks(l.mapEnd,f,o,e),i.execute(l))}})}function $l(t){return t.type==="3d"?t.resourceController.scheduler.registerTask(Jn.SNAPPING):Kn}function Cl(t,e,i){return{context:new Fs({editGeometryOperations:t.editGeometryOperations,elevationInfo:t.elevationInfo,pointer:t.pointer,vertexHandle:m(e.info)?e.info.handle:null,excludeFeature:t.excludeFeature,visualizer:t.visualizer}),originalPos:m(e.snapOrigin)?t.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:m(e.scenePoints)?e.scenePoints.sceneStart:null,frameTask:i}}function Ns(t,[e,i,n]){const s=Ze(t);return s.x+=e,s.y+=i,s.hasZ&&(s.z+=n),s}function Ol(t,e){return g(t)||g(e)?null:Ns(t,Vi(e.sceneEnd,e.sceneStart))}function Vi(t,e){const i=t.hasZ&&e.hasZ?t.z-e.z:0;return[t.x-e.x,t.y-e.y,i]}function ks(t,e,[i,n,s],r){t.x=e.x+i,t.y=e.y+n,r&&t.hasZ&&e.hasZ&&(t.z=e.z+s)}function Tl(t,e){if(!t.hasZ())return null;const i=e.vertices;let n=null;for(const s of i){const r=t.getZ(s.pos);if(m(n)&&m(r)&&Math.abs(r-n)>1e-6)return null;g(n)&&(n=r)}return n}function Hn(t){return t}let Te=class extends ge{constructor(t){super(t),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=Qn(async(e,i,n,s)=>{const r=this._frameTask;if(g(r))return;const a=await r.schedule(()=>i.snap({...e,context:n,signal:s}),s);a.valid&&await r.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&m(this._snapPoints)&&(this.stagedPoint=i.update({...this._snapPoints,context:n}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(t){this._stagedPoint=this.constrainResult(t)}initialize(){var e,i;const t=this.view.type==="3d"?(i=(e=this.view)==null?void 0:e.resourceController)==null?void 0:i.scheduler:null;this._frameTask=m(t)?t.registerTask(Jn.SNAPPING):Kn}destroy(){this._abortController=wt(this._abortController),this._frameTask=Gi(this._frameTask)}update(t,e,i){this._snapPoints=t;const{point:n,scenePoint:s}=t,r=e.update({point:n,scenePoint:s,context:i});return this.stagedPoint=r,r}async snap(t,e,i){const{point:n,scenePoint:s}=t;return this.stagedPoint=e.update({point:n,scenePoint:s,context:i}),this._snapPoints=t,g(this._abortController)&&(this._abortController=new AbortController),this._snap(t,e,i,this._abortController.signal)}async resnap(t,e){g(this._snapPoints)||await this.snap(this._snapPoints,t,e)}abort(){this._abortController=wt(this._abortController),this._snapPoints=null}};h([p({constructOnly:!0})],Te.prototype,"view",void 0),h([p()],Te.prototype,"stagedPoint",null),h([p()],Te.prototype,"constrainResult",void 0),h([p()],Te.prototype,"_stagedPoint",void 0),Te=h([F("esri.views.interactive.snapping.SnappingOperation")],Te);let N=class extends Ii{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new ii,this._getSnappingContext=yo(i=>new Fs({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new xa(new ba("point",Ma(!0,!1,this.view.spatialReference))),visualizer:new Do})),this._snappingManagerResult=Pl(t.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=vi(),this._focusedOffsetManipulatorMaterial=vi(),this._thinOffsetManipulatorMaterial=vi(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Le(2)}),this._constraintSnappingIndicator=new $e({view:t.view,attached:!0,width:1,color:E.toUnitRGBA(D.constraint.color),renderOccluded:x.OccludeAndTransparent,stipplePattern:Le(5)});const e=E.toUnitRGBA(D.disabledPointIndicator.color);e[3]*=D.disabledPointIndicator.opacity,this._stagedStartIndicator=new qo({view:t.view,attached:!1,color:e,size:2*D.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:x.OccludeAndTransparent})}initialize(){this._snappingOperation=new Te({view:this.view}),this._orientationManipulatorTexture=ga(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new wa({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:x.Opaque});const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("after-add",e=>this._addComputation(e.item)),t.on("after-remove",e=>this._removeComputation(e.item))]),this.addHandles([M(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:e,stagedComputation:i})=>{if(g(i)||g(e))return;const n=Ze(e,new Ye);this._applyPointUpdate(i,{endPoint:n})},it),M(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(e,i)=>{const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=e;if(n===(i==null?void 0:i.stagedDimension)&&r===(i==null?void 0:i.firstGrabbedManipulator)){for(const a of[s,i==null?void 0:i.selectedComputation])if(m(a)){const l=this._computationManipulators.get(a);this._updateManipulators(a,l,e)}}else for(const[a,l]of this._computationManipulators)this._updateManipulators(a,l,e)},k),M(()=>this.analysis.style.lineSize,e=>{this._updateManipulatorStyle(e)},Bt),M(()=>this.view.state.camera,()=>{m(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)}),M(()=>Gr(this._stagedComputation,e=>{const i=e.elevationAlignedStartPoint,n=y();return m(i)&&this.view.renderCoordsHelper.toRenderCoords(i,n)?n:null}),e=>{m(e)?(this._stagedStartIndicator.vertices=[e],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),To(this,()=>{const e=this._activeComputation,i=this._stagedComputation;if(g(e)||m(i)){const n=et(this.view.inputManager.latestPointerType,"mouse"),s=this._getSnappingContext(n);this.updatingHandles.addPromise(Ci(this._snappingOperation.resnap(this._snappingManager,s)))}if(m(e)){const{start:n,end:s}=this._computationManipulators.get(e);if(n.grabbing||s.grabbing){const r=n.grabbing?"start":"end",a=this._computeConstraint(e);Po(e,r,{constraint:a,view:this.view})}}})}destroy(){this._snappingOperation=yt(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(m(this._stagedComputation))return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&m(t)?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return g(t)||g(e)||e.dimension!==t?null:e}get _constraintHandles(){return[Fi(()=>this.analysisViewData.selectedComputation,t=>{t.previousConstraint=this._computeConstraint(t)},{...k,equals:Oi}),M(()=>{const t=this._activeComputation;if(g(t))return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}},(t,e)=>{if(m(t)&&g(e)){const{measureType:i,orientation:n,computation:s}=t;switch(s.previousConstraint){case K.Horizontal:s.preConstraintProperties={measureType:R.Horizontal,orientation:0};break;case K.Vertical:s.preConstraintProperties={measureType:R.Vertical,orientation:0};break;case K.Direct:s.preConstraintProperties={measureType:R.Direct,orientation:n};break;default:s.preConstraintProperties={measureType:i,orientation:n}}}g(t)&&m(e)&&(e.computation.preConstraintProperties=null)},it)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[M(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),g(i))n.attached=!1;else if(i===e)n.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(i),a=()=>{n.attached=s.grabbing||r.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),r.events.on("grab-changed",a)],t)}}),M(()=>{const e=this._activeComputation;return m(e)?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:i})=>{const n=this._constraintSnappingIndicator;m(e)&&m(i)&&i!==K.Direct?(n.visible=!0,n.setGeometryFromSegment(e.directSegment)):n.visible=!1})]}removeStaged(){return!!m(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(g(e)){const i=this._onUnstagedClick(t);return this.analysis.dimensions.add(i),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if(e==="touch")return;const i=this._getSnappingContext(e);this.updatingHandles.addPromise(Ci(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){m(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if(e==="mouse"){const s=this._getSnappingContext(e);i=this._snappingManager.update({point:t,context:s})}const n=new ta({startPoint:Ze(i,new Ye),endPoint:null,measureType:R.Horizontal});return this._stagedDimension=n,this._resetSnappingState(),n}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(g(i))return;let n=t;if(e==="mouse"){const r=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:r})}const s=Ze(n,new Ye);this._applyPointUpdate(i,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),n=this._setupOffsetManipulator(t),s=this._setupHeadingManipulator(t),r=this._setupRotationManipulator(t),a=this._setupMeasureTypeManipulator(t,R.Direct),l=this._setupMeasureTypeManipulator(t,R.Horizontal),o=this._setupMeasureTypeManipulator(t,R.Vertical),d=new Xa({start:e,end:i,offset:n,heading:s,rotation:r,direct:a,horizontal:l,vertical:o});this._setupComputationToManipulatorsSync(t,d),this._computationManipulators.set(t,d),this.manipulators.addMany(d.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(!g(e)){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const i of e.values())this.manipulators.remove(i)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([M(()=>t.geometry,()=>this._updateManipulators(t,e),{...k,equals:Oi})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,s=Ja(i,{metadata:n}),r=eo(s,{isStart:e.isStart,createSnappingPipelineStep:a=>Ml({snappingContext:this._getSnappingContext(a),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:a=>this._applyPointUpdate(t,a),view:i});return this._computationHandles.add(r,t),s}_setupOffsetManipulator(t){const{view:e}=this,i=Ka(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=to(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=Pn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=io(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=Pn(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=no(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=Qa(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),s=ao(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(s,t),n}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:n,selectedComputation:s,firstGrabbedManipulator:r}=i,{start:a,end:l,offset:o,heading:d,rotation:c}=e,u=s===t,f=xt(t),{dimension:_}=t;for(const w of e.values()){const L=f&&g(n)&&(g(r)||w===r);w===o?(w.available=L,w.selected=u):w.available=L&&u}if(!f)return;m(this._computeConstraint(t))?e.forEachMeasureTypeManipulator(w=>w.available=!1):e.manipulatorForMeasureType(_.measureType).available=!1;for(const w of[d,c])_.measureType===R.Direct&&_.offset!==0||(w.available=!1);qi(t)?c.available=!1:d.available=!1;const{geometry:S}=t;a.renderLocation=S.directSegment.startRenderSpace,l.renderLocation=S.directSegment.endRenderSpace;const{renderCoordsHelper:P}=this.view;oo(o,S,P),d.available&&lo(d,t,P),c.available&&co(c,t,P),e.forEachMeasureTypeManipulator((w,L)=>{w.available&&po(w,t,L,P)})}_updateManipulatorStyle(t){const e=_o(t),i=Bi(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:a}of this._computationManipulators.values())s.radius=i/2,xn(r,n),xn(a,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=Yt(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const s=Xt(n,i.renderCoordsHelper);if(g(s))return;const r=this._computeConstraint({...n,geometry:s});xs(t,e,{...n,constraint:r,unconstrainedGeometry:s,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(g(t.geometry))return;t.geometry.directSegment.eval(.5,In);const e=this.view.state.camera.computeRenderPixelSizeAt(In);t.dimension.offset=D.initialOffsetPx*e}_computeConstraint(t){return wo(So(t,this._snappingManager.options),this.view)}get testInfo(){const t=e=>this.analysisViewData.computations.find(i=>i.dimension===e);return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=x.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:i}of e.renderObjects)i.material.setParameters({renderOccluded:x.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return m(i)?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function vi(){const{color:t,opacity:e}=D.offsetManipulator;return new pe({color:[...E.toUnitRGB(t),e],width:1,renderOccluded:x.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}h([p({constructOnly:!0})],N.prototype,"analysis",void 0),h([p({constructOnly:!0})],N.prototype,"analysisViewData",void 0),h([p({constructOnly:!0})],N.prototype,"manipulators",void 0),h([p({constructOnly:!0})],N.prototype,"parentTool",void 0),h([p({constructOnly:!0,nonNullable:!0})],N.prototype,"view",void 0),h([p({readOnly:!0})],N.prototype,"updating",null),h([p()],N.prototype,"firstGrabbedManipulator",null),h([p()],N.prototype,"hasGrabbedManipulators",null),h([p()],N.prototype,"snappingOptions",null),h([p()],N.prototype,"_stagedDimension",void 0),h([p()],N.prototype,"_activeComputation",null),h([p()],N.prototype,"_stagedComputation",null),N=h([F("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],N);const In=y();var Be;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(Be||(Be={}));let Y=class extends ha{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=D.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Fr(this.view.state.viewingMode),this._intersector.options.store=Nr.MIN,this._lengthDimensionSubTool=new N({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([je(this._lengthDimensionSubTool),Zt(()=>this._clearPointerMoveTimeout()),M(()=>this.state,t=>{t===Be.Created&&this.finishToolCreation()},k),Fi(()=>this.firstGrabbedManipulator,t=>{this.selectedDimension=t.metadata},k),M(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),k)])}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?m(this._activeSubTool)?Be.Creating:Be.Created:Be.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(Rn.cancel===t.key){if(m(this._activeSubTool)&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else Rn.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){m(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(g(this._activeSubTool))return;const e=this._intersectScreen(t);g(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),g(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);g(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){m(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=kr(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=$.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_removeSelected(){m(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Gi(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(t=>{t.manipulator.state|=fe}),this._prevPointerMoveTimeout=jr.setTimeout(()=>{this.manipulators.forEach(t=>{t.manipulator.state&=~fe})},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};h([p({constructOnly:!0})],Y.prototype,"view",void 0),h([p({constructOnly:!0})],Y.prototype,"analysis",void 0),h([p({readOnly:!0})],Y.prototype,"state",null),h([p({readOnly:!0})],Y.prototype,"updating",null),h([p({readOnly:!0})],Y.prototype,"cursor",null),h([p({constructOnly:!0})],Y.prototype,"analysisViewData",void 0),h([p()],Y.prototype,"selectedDimension",null),h([p()],Y.prototype,"automaticManipulatorSelection",void 0),h([p()],Y.prototype,"_activeSubTool",void 0),h([p()],Y.prototype,"_lengthDimensionSubTool",void 0),Y=h([F("esri.views.3d.analysis.Dimension.DimensionTool")],Y);class Rl extends ts{constructor(e,i){super(e),this._hasExternalMaterial=!1,this._renderOccluded=x.OccludeAndTransparent,this._width=1,this._color=Ut(1,0,1,1),this._placement="end",this._textureId=null,this._material=i,this._hasExternalMaterial=m(i),this.applyProps(e)}setGeometryFromSegment(e,i){const n=e.endRenderSpace;this.transform=qr(Dl,n),this._normal=i;const{points:s}=e.createRenderGeometry(n,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return m(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,m(this._material)&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return m(this._material)?this._material.parameters.width:this._width}set width(e){this._width=e,m(this._material)&&this._material.setParameters({width:e})}get color(){return m(this._material)?this._material.parameters.color:this._color}set color(e){this._color=qn(e),m(this._material)&&this._material.setParameters({color:this._color})}get placement(){return m(this._material)?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,m(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return m(this._material)?this._material.parameters.textureId:this._textureId}set textureId(e){this._textureId=e,m(this._material)&&this._material.setParameters({textureId:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new es({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const i of Ur(this.geometry,this.normal)){const n=Wr(Q(this._material),i);e.addGeometry(n)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(Q(this._material))}}const Dl=Hi();class Al{set visible(e){for(const i of this._visualElements.values())i.attached=e}constructor(e){this.destroyed=!1,this._handles=new ii,this._messages=null,this._labelSegment=new Ve;const{analysis:i,computation:n,view:s,messages:r}=e;this.analysis=i,this.computation=n,this.view=s,this._messages=r;const a=e.visible,l={view:s,attached:a},{fontSize:o,textColor:d,textBackgroundColor:c}=i.style;this._visualElements=new Il({marker:new Rl(l,e.markerMaterial),dimension:new $e(l,e.dimensionLineMaterial),startOffset:new $e(l,e.offsetLineMaterial),endOffset:new $e(l,e.offsetLineMaterial),dimensionSmall:new $e(l,e.smallDimensionLineMaterial),startOffsetSmall:new $e(l,e.smallOffsetLineMaterial),endOffsetSmall:new $e(l,e.smallOffsetLineMaterial),label:new ra({view:s,attached:a,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:de(o),textColor:d.clone(),backgroundColor:c.clone()})}),this._handles.add([M(()=>n.geometry,u=>{this.updateCameraDependentElements(s.state.camera,u,i.style),m(n.geometry)&&this._updateLines(n.geometry)},{...Bt,equals:Oi}),M(()=>n.length,u=>this._updateLabelContent(u),Bt)])}destroy(){this.destroyed=!0,this._handles=yt(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const i=wn(zl,Pt.Start,e.directSegment,e.dimensionSegment),n=wn(Vl,Pt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(i),s.endOffset.setGeometryFromSegment(n),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(i),s.endOffsetSmall.setGeometryFromSegment(n)}updateCameraDependentElements(e,i,n){const s=this._visualElements;if(g(i)){for(const P of s.values())P.visible=!1;return}const r=e.computeScreenPixelSizeAt(i.dimensionSegment.eval(.5,Hl)),a=Ga(i,r),l=a<(de(n.lineSize)*D.smallScreenLengthLineSizeFactor)**2,o=!l;s.marker.visible=o,s.dimension.visible=o,s.startOffset.visible=o,s.endOffset.visible=o,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const d=de(n.fontSize)*D.labels.minScreenLengthFontSizeFactor,{label:c}=s;if(c.visible=a>=d**2,!c.visible)return;const{dimensionSegment:u,primaryOffsetAxis:f}=i,{offset:_}=this.computation.dimension,S=(Math.sign(_)>=0?1:-1)*Ll(n)*r;Da(this._labelSegment,u,f,S),c.updateLabelPosition()}updateLabelStyle(e){const{label:i}=this._visualElements;i.fontSize=de(e.fontSize),i.textColor=e.textColor,i.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:i}=this.computation;this._updateLabelContent(i)}_updateLabelContent(e){const{label:i}=this._visualElements;g(e)||g(this._messages)?i.text="":i.text=aa(this._messages,e,e.unit)}}function Ll(t){return 1.5*de(t.fontSize)+D.labels.marginPx+de(t.lineSize/2)}const zl=new Ve,Vl=new Ve,Hl=y();class Il{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}class Gl{constructor(e,i){this._textures=e,this._textureRepository=i,this._texturesByPrimitive=new Map}acquire(e){if(!this._texturesByPrimitive.has(e)){const i=Br(this._textures,e),n=new $a(this._textureRepository,i.texture.id);return this._texturesByPrimitive.set(e,{result:i,reference:n}),i.texture}return this._texturesByPrimitive.get(e).result.texture}destroy(){this._texturesByPrimitive.forEach(({result:e,reference:i})=>{i.dispose(),e.release()}),this._texturesByPrimitive.clear()}}let ve=class extends ge{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new es({width:1,anchor:Zr.Tip,color:dt,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:x.OccludeAndTransparent}),this._dimensionLineMaterial=new pe({width:1,color:dt,renderOccluded:x.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new pe({width:1,color:dt,renderOccluded:x.OccludeAndTransparent,stipplePattern:Le(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new pe({width:1,color:dt,renderOccluded:x.OccludeAndTransparent}),this._smallOffsetLineMaterial=new pe({width:1,color:dt,renderOccluded:x.OccludeAndTransparent,stipplePattern:Le(5),stippleScaleWithLineWidth:!0})}initialize(){var i;const t=(i=this.view.sharedSymbolResources)==null?void 0:i.textures;if(m(t)){const{textureRepository:n}=this.view._stage.renderView,s=new Gl(t,n),r=s.acquire("triangle");this.addHandles(Zt(()=>s.destroy())),this._markerMaterial.setParameters({textureId:r.id})}for(const n of this._lineMaterials())this.view._stage.add(n),this.addHandles(Zt(()=>{this.view._stage.remove(n),n.dispose()}));const{computations:e}=this.analysisViewData;for(const n of e)this._addComputation(n);this.addHandles([e.on("change",({added:n,removed:s})=>{for(const r of s)this._removeComputation(r);for(const r of n)this._addComputation(r)}),M(()=>E.toUnitRGBA(this.analysis.style.color),n=>{for(const s of this._lineMaterials())s.setParameters({color:n})},k),M(()=>this.analysis.style.lineSize,n=>{const s=de(n);this._markerMaterial.setParameters({width:s*D.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:s,markerParameters:this._markerMaterial.parameters});const r=Math.max(s*D.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:r})},k),M(()=>({camera:this.view.state.camera,style:Fl(this.analysis)}),({camera:n,style:s})=>{for(const[r,a]of this._dimensionVisualizations)a.updateCameraDependentElements(n,r.geometry,s),a.updateLabelStyle(s)}),M(()=>this.visible,n=>{for(const s of this._dimensionVisualizations.values())s.visible=n})]),this.addHandles([Yr(()=>this._updateMessageBundle()),Fi(()=>!this.loadingMessages,()=>{for(const n of this._dimensionVisualizations.values())n.updateUnitsMessages(this._messages)},it)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:x.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Al({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);g(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Xr("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Fl(t){const{fontSize:e,lineSize:i,textColor:n,textBackgroundColor:s}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:s.clone(),textColor:n.clone()}}h([p({constructOnly:!0})],ve.prototype,"analysisViewData",void 0),h([p({constructOnly:!0,nonNullable:!0})],ve.prototype,"view",void 0),h([p()],ve.prototype,"analysis",null),h([p()],ve.prototype,"visible",null),h([p()],ve.prototype,"loadingMessages",void 0),ve=h([F("esri.views.3d.analysis.Dimension.DimensionVisualization")],ve);let ut=class extends ge{constructor(t){super(t),this.dimension=null,this.length=null}};h([p({constructOnly:!0,nonNullable:!0})],ut.prototype,"dimension",void 0),h([p()],ut.prototype,"length",void 0),ut=h([F("esri.views.3d.analysis.LengthDimensionResult")],ut);const Nl=ut;let X=class extends ge{constructor(t){super(t),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new Nl({dimension:e}),...i}}initialize(){this.addHandles([M(()=>this.dimension.startPoint,t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t),k),M(()=>this.dimension.endPoint,t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t),k)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};h([p({constructOnly:!0,nonNullable:!0})],X.prototype,"result",void 0),h([p({constructOnly:!0,nonNullable:!0})],X.prototype,"projectAndAlignPoint",void 0),h([p()],X.prototype,"dimension",null),h([p()],X.prototype,"length",null),h([p()],X.prototype,"geometry",void 0),h([p()],X.prototype,"unconstrainedGeometry",void 0),h([p()],X.prototype,"elevationAlignedStartPoint",void 0),h([p()],X.prototype,"elevationAlignedEndPoint",void 0),h([p()],X.prototype,"preConstraintProperties",void 0),h([p()],X.prototype,"previousConstraint",void 0),X=h([F("esri.views.3d.analysis.LengthDimensionComputation")],X);const kl=t=>{let e=class extends t{constructor(...i){super(...i),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new rt}createLengthDimensions(i){throw new Error("Method not implemented.")}};return h([p({constructOnly:!0})],e.prototype,"view",void 0),h([p({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),h([p()],e.prototype,"tool",void 0),h([p({readOnly:!0})],e.prototype,"results",null),h([p()],e.prototype,"selectedDimension",void 0),h([p()],e.prototype,"interactive",void 0),h([p()],e.prototype,"visible",void 0),e=h([F("esri.views.analysis.DimensionAnalysisView")],e),e};let W=class extends kl(Jr(ge)){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.computations=new rt,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(g(t))return null;const{spatialReference:e,elevationProvider:i}=this.view,n=Kr(t,e,i);return g(n)&&Qr(this.analysis,t.spatialReference,Nn.getLogger(this.declaredClass)),n},this.addHandles([ua(this,Y),gn(()=>this.analysis.dimensions,"after-add",t=>this._onDimensionAdd(t.item),{onListenerAdd:t=>{for(const e of t)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),gn(()=>this.analysis.dimensions,"after-remove",t=>this._onDimensionRemove(t.item))]),this._analysisVisualization=new ve({analysisViewData:this,view:this.view}),this._analysisController=new Ce({analysisViewData:this,view:this.view})}destroy(){this._placementTask=wt(this._placementTask),this._analysisVisualization=yt(this._analysisVisualization),pa(this)}get updating(){var t,e;return(e=(t=this._analysisVisualization)==null?void 0:t.loadingMessages)!=null?e:!1}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToComputations.get(t).result)}get selectedComputation(){const{selectedDimension:t}=this;return g(t)?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=wt(this._placementTask),this._placementTask=fa(this,t),this._placementTask.promise}_onDimensionAdd(t){const{computations:e,_dimensionsToComputations:i}=this;if(i.has(t))return;const n=new X({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});e.add(n),i.set(t,n)}_onDimensionRemove(t){const{computations:e,_dimensionsToComputations:i}=this,n=e.findIndex(r=>r.dimension===t),s=e.getItemAt(n);s.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(n),i.delete(t),yt(s)}_onDimensionsClear(){this.computations.drain(t=>t.destroy()),this._dimensionsToComputations.clear()}};h([p({readOnly:!0})],W.prototype,"type",void 0),h([p()],W.prototype,"tool",void 0),h([p()],W.prototype,"updating",null),h([p({readOnly:!0})],W.prototype,"results",null),h([p({readOnly:!0})],W.prototype,"computations",void 0),h([p()],W.prototype,"selectedDimension",void 0),h([p()],W.prototype,"selectedComputation",null),h([p()],W.prototype,"_analysisVisualization",void 0),h([p()],W.prototype,"_analysisController",void 0),h([p()],W.prototype,"_dimensionsToComputations",void 0),h([p()],W.prototype,"_placementTask",void 0),W=h([F("esri.views.3d.analysis.DimensionAnalysisView3D")],W);const jl=W;var od=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:jl});export{od as D,Xo as Z,Yi as a,rd as b,Zi as d,ad as f,sd as l,en as n,sl as r,nl as s};
