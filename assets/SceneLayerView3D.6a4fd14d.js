import{t as d,r as s,hr as h,a6 as p,a7 as _,O as F,z as u,bj as v,j as b,e as n,y as a,iJ as w,jH as E,a as I}from"./index.1c994251.js";import{f as C}from"./WhereClause.95780840.js";import{o as x}from"./floorFilterUtils.4de71259.js";import{v as S,l as Q,I as O}from"./I3SMeshView3D.badb2651.js";import{n as j}from"./LayerView3D.5d1f2a4a.js";import{c as q,i as H,a as R,u as A,b as D,E as $}from"./SceneLayerView.01c69de5.js";import{P as c,h as P,l as L,n as U}from"./I3SQueryFeatureStore.4958dc38.js";import{n as g}from"./I3SNode.79924b56.js";import{A as G}from"./I3SOverrides.e6d13888.js";import{g as N,h as V,Y as M}from"./I3SUtil.20702f27.js";import{t as z}from"./DefinitionExpressionSceneLayerView.db7f564c.js";import{c as T}from"./PopupSceneLayerView.99867906.js";import"./executionError.c4c51b90.js";import"./SceneModification.afe24382.js";import"./persistable.0ab3ae03.js";import"./multiOriginJSONSupportUtils.6105c957.js";import"./resourceExtension.3a7390a2.js";import"./Graphics3DObjectStates.f52940ee.js";import"./rendererConversion.434aee8c.js";import"./optimizedFeatureQueryEngineAdapter.489d0347.js";import"./centroid.ea6923ab.js";import"./PooledRBush.b3febf2a.js";import"./quickselect.2c5f2780.js";import"./SceneLayerWorker.4c44ee13.js";import"./FeatureLikeLayerView3D.96913f8f.js";import"./dehydratedFeatureComparison.e916f0d8.js";import"./queryForSymbologySnapping.a0343d2d.js";import"./elevationInfoUtils.8f2b572c.js";import"./hash.079e8d2d.js";import"./QueryEngine.e5fa8c77.js";import"./QueryEngineResult.e9614097.js";import"./utils.191860e4.js";import"./generateRendererUtils.5f47c7a6.js";import"./json.5152e73f.js";import"./QueryEngineCapabilities.ea616409.js";import"./FeatureStore.cebd9735.js";import"./BoundsStore.863b4bac.js";import"./projectExtentUtils.a39e451e.js";import"./LayerView.5346cb05.js";import"./I3SBinaryReader.13a11174.js";import"./RenderTexture.fd243b89.js";import"./FeatureLayerView3D.57be8cb5.js";import"./FeatureLayerViewBase3D.0f667ed5.js";import"./EventedSet.8542dabe.js";import"./popupUtils.1e985717.js";import"./RefreshableLayerView.dd035789.js";const y=D();let i=class extends S(z(T(j($)))){constructor(){super(...arguments),this.type="scene-layer-3d",this.progressiveLoadFactor=1,this._elevationContext="scene",this._isIntegratedMesh=!1,this._supportsLabeling=!0,this._interactiveEditingSessions=new Map,this._queryEngine=null}get i3slayer(){return this.layer}tryRecycleWith(e,t){return e.url===this.layer.url&&this.i3sOverrides.isEmpty?e.load(t).then(()=>{var l;N(this.layer,e,this.i3sOverrides),this.layer=e,this.i3sOverrides.destroy();const r=(l=this.view.resourceController)==null?void 0:l.memoryController;this.i3sOverrides=new G({view:this.view,layer:e,memoryController:r}),this.resetHighlights()}):null}get layerPopupEnabled(){return this.layer.popupEnabled}get filter(){return this._get("filter")}set filter(e){this._set("filter",c.checkSupport(e)?e:null)}get viewFilter(){const e=this.filter,t=this.layerFilter;if(d(e)&&d(t))return null;const r=this._get("viewFilter");return d(r)?new c({layerFilter:t,viewFilter:e,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:l=>this._loadAsyncModule(l),addSqlFilter:(l,o)=>this.addSqlFilter(l,o,this.logError)}):(r.viewFilter=e,r.layerFilter=t,r)}get requiredFields(){var e,t;return(t=(e=this._fieldsHelper)==null?void 0:e.requiredFields)!=null?t:[]}get _floorFilterClause(){const e=x(this);return s(e)?C.create(e,this.layer.fieldsIndex):null}get _excludeObjectIdsSorted(){let e=this.layer.excludeObjectIds.toArray();return h()&&this.i3sOverrides.is3DOFL&&this.i3sOverrides.geometryChangedObjectIds.length>0&&(e=e.concat(this.i3sOverrides.geometryChangedObjectIds)),e.length?e.sort((t,r)=>t-r):null}get _objectQualitySettings(){var e,t,r;return(r=(t=(e=this.view)==null?void 0:e.qualitySettings)==null?void 0:t.sceneService)==null?void 0:r.object}get lodFactor(){var e,t;return(t=(e=this._objectQualitySettings)==null?void 0:e.lodFactor)!=null?t:1}get lodCrossfadeinDuration(){var e;return(e=this._objectQualitySettings.lodCrossfadeinDuration)!=null?e:0}get lodCrossfadeoutDuration(){var e;return(e=this._objectQualitySettings.lodCrossfadeoutDuration)!=null?e:0}get lodCrossfadeUncoveredDuration(){var e;return(e=this._objectQualitySettings.lodCrossfadeUncoveredDuration)!=null?e:0}get updatingProgressValue(){var e,t;return(t=(e=this._controller)==null?void 0:e.updatingProgress)!=null?t:0}initialize(){this._fieldsHelper=new q({layerView:this}),this.updatingHandles.add(()=>this.layer.rangeInfos,t=>this._rangeInfosChanged(t),p),this.updatingHandles.add(()=>this.layer.renderer,t=>this.updatingHandles.addPromise(this._rendererChange(t)),p);const e=()=>this._filterChange();this.updatingHandles.add(()=>this.parsedDefinitionExpression,e),this.updatingHandles.add(()=>this.filter,e),this.updatingHandles.add(()=>this._floorFilterClause,e),this.updatingHandles.add(()=>this._excludeObjectIdsSorted,e),this.updatingHandles.add(()=>s(this.viewFilter)?this.viewFilter.sortedObjectIds:null,e),this.updatingHandles.add(()=>s(this.viewFilter)?this.viewFilter.parsedWhereClause:null,e),this.updatingHandles.add(()=>[s(this.viewFilter)?this.viewFilter.parsedGeometry:null,s(this.filter)?this.filter.spatialRelationship:null,s(this.layer.filter)?this.layer.filter.spatialRelationship:null],()=>this._geometryFilterChange()),this.handles.add(this.layer.on("apply-edits",t=>this.updatingHandles.addPromise(t.result))),this.handles.add(this.layer.on("edits",t=>this._handleEdits(t)))}destroy(){this._fieldsHelper=_(this._fieldsHelper)}_rangeInfosChanged(e){e!=null&&e.length>0&&F.getLogger(this.declaredClass).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}createQuery(){const e={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return s(this.filter)?this.filter.createQuery(e):new u(e)}queryExtent(e,t){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(e),t==null?void 0:t.signal)}queryFeatureCount(e,t){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(e),t==null?void 0:t.signal)}queryFeatures(e,t){return this._ensureQueryEngine().executeQuery(this._ensureQuery(e),t==null?void 0:t.signal).then(r=>{if(!(r!=null&&r.features))return r;const l=this.layer;for(const o of r.features)o.layer=l,o.sourceLayer=l;return r})}queryObjectIds(e,t){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(e),t==null?void 0:t.signal)}_ensureQueryEngine(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine}_createQueryEngine(){var t;const e=Q(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new P({layerView:this,priority:v.FEATURE_QUERY_ENGINE,spatialIndex:new L({featureAdapter:new U({objectIdField:this.layer.objectIdField,attributeStorageInfo:(t=this.layer.attributeStorageInfo)!=null?t:[],getFeatureExtent:e}),forAllFeatures:(r,l)=>this._forAllFeatures((o,f,m)=>r({id:o,index:f,meta:m}),l,O.ALL_IN_CLIPPING_AREA),getFeatureExtent:e,sourceSpatialReference:V(this.layer),viewSpatialReference:this.view.spatialReference})})}highlight(e){const t=this._highlights;if(e instanceof u){const{set:r,handle:l}=t.acquireSet();return this.queryObjectIds(e).then(o=>t.setFeatureIds(r,o)),l}return super.highlight(e)}createInteractiveEditSession(e){return H(this._attributeEditingContext,e)}_createLayerGraphic(e){const t=new b(null,null,e);return t.layer=this.layer,t.sourceLayer=this.layer,t}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}getFilters(){const e=super.getFilters(),t=this._excludeObjectIdsSorted;return s(t)&&e.push(r=>M(t,!1,r)),this._floorFilterClause&&this.addSqlFilter(e,this._floorFilterClause,this.logError),this.addSqlFilter(e,this.parsedDefinitionExpression,this.logError),s(this.viewFilter)&&this.viewFilter.addFilters(e,this.view,this._controller.crsIndex,this._collection),e}isUpdating(){return super.isUpdating()||this.layerFilterUpdating||s(this.viewFilter)&&this.viewFilter.updating||s(this.i3sOverrides)&&this.i3sOverrides.updating}_ensureQuery(e){return this._addDefinitionExpressionToQuery(d(e)?this.createQuery():u.from(e))}get _attributeEditingContext(){var e;return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:t=>this._forAllNodes(r=>s(r)?t(r.node,r.featureIds):null),attributeStorageInfo:(e=this.i3slayer.attributeStorageInfo)!=null?e:[],i3sOverrides:this.i3sOverrides,getAttributeData:t=>this.getAttributeData(t),setAttributeData:(t,r)=>this.setAttributeData(t,r),clearMemCache:()=>this.clearMemCache()}}_handleEdits(e){h()&&R(this._attributeEditingContext,e),A(this._attributeEditingContext,e)}get hasGeometryFilter(){const e=this.viewFilter;return s(e)&&s(e.parsedGeometry)}computeNodeFiltering(e){const t=this.viewFilter;return d(t)||!this.view.spatialReference||t.isMBSGeometryVisible(e,this.view.spatialReference,this._controller.crsIndex)?g.Unmodified:g.Culled}};n([a()],i.prototype,"i3slayer",null),n([a(w)],i.prototype,"updatingProgress",void 0),n([a({type:E})],i.prototype,"filter",null),n([a({readOnly:!0})],i.prototype,"viewFilter",null),n([a(y.requiredFields)],i.prototype,"requiredFields",null),n([a(y.availableFields)],i.prototype,"availableFields",void 0),n([a()],i.prototype,"_fieldsHelper",void 0),n([a()],i.prototype,"_floorFilterClause",null),n([a()],i.prototype,"_excludeObjectIdsSorted",null),n([a()],i.prototype,"_objectQualitySettings",null),n([a()],i.prototype,"lodFactor",null),n([a()],i.prototype,"updatingProgressValue",null),i=n([I("esri.views.3d.layers.SceneLayerView3D")],i);const Le=i;export{Le as default};
